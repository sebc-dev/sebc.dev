name: Quality Gate
on: [pull_request]

permissions:
  contents: read

concurrency:
  group: quality-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - run: npm ci

      # Formatage
      - run: npx prettier --check .

      # Lint
      - run: npx eslint .
      - run: npx markdownlint-cli2 "src/content/**/*.{md,mdx}"
      - run: npx astro check

      # Code mort
      - run: npx knip

      # Tests unitaires + composants
      - run: npx vitest run --coverage

      # Sécurité
      - run: npm audit --audit-level=moderate

  e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - run: npm ci
      - run: npx playwright install chromium --with-deps
      - run: npx playwright test

  lighthouse:
    runs-on: ubuntu-latest
    needs: [check]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - run: npm ci
      - run: npm run build
      - uses: treosh/lighthouse-ci-action@v12
        with:
          configPath: ./lighthouserc.json
          uploadArtifacts: true
