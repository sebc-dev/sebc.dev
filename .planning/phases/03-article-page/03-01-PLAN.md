---
phase: 03-article-page
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - astro.config.mjs
  - src/styles/global.css
  - src/lib/articles.ts
  - src/i18n/ui.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Expressive Code integration is active and processes code blocks before MDX"
    - "Heading anchors are generated on all h2/h3 elements in MDX content"
    - "Related articles can be queried by shared tags and category"
    - "Article page translation strings exist in both EN and FR"
  artifacts:
    - path: "astro.config.mjs"
      provides: "EC integration before mdx(), rehype plugins, shikiConfig removed"
      contains: "astroExpressiveCode"
    - path: "src/styles/global.css"
      provides: "EC-compatible styles, heading anchor styles, TOC active styles, reading progress styles"
      contains: ".heading-anchor"
    - path: "src/lib/articles.ts"
      provides: "getRelatedArticles() function"
      exports: ["getRelatedArticles"]
    - path: "src/i18n/ui.ts"
      provides: "Article page i18n keys"
      contains: "article.toc"
  key_links:
    - from: "astro.config.mjs"
      to: "astro-expressive-code"
      via: "integration placed before mdx()"
      pattern: "astroExpressiveCode.*mdx"
    - from: "astro.config.mjs"
      to: "rehype-autolink-headings"
      via: "mdx rehypePlugins array"
      pattern: "rehypePlugins"
    - from: "src/lib/articles.ts"
      to: "astro:content"
      via: "getCollection query filtered by locale"
      pattern: "getArticlesByLocale"
---

<objective>
Install and configure Expressive Code, rehype heading anchors, update global CSS for article page styles, extend the article data layer with related articles query, and add article page i18n strings.

Purpose: Establish all configuration and data foundations that article page components and layouts depend on.
Output: Configured astro.config.mjs with EC + rehype, updated global.css, extended lib/articles.ts, extended i18n/ui.ts.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-article-page/03-RESEARCH.md
@astro.config.mjs
@src/styles/global.css
@src/lib/articles.ts
@src/i18n/ui.ts
@src/content.config.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install packages and configure Expressive Code + rehype heading anchors</name>
  <files>package.json, astro.config.mjs, src/styles/global.css</files>
  <action>
1. Install new dependencies:
   ```bash
   npm install astro-expressive-code rehype-autolink-headings hastscript
   ```

2. Update `astro.config.mjs`:
   - Add imports: `import astroExpressiveCode from 'astro-expressive-code'`, `import { rehypeHeadingIds } from '@astrojs/markdown-remark'`, `import rehypeAutolinkHeadings from 'rehype-autolink-headings'`, `import { h } from 'hastscript'`
   - In `integrations` array, place `astroExpressiveCode(...)` BEFORE `mdx()`. This is critical -- EC must process code blocks before MDX.
   - Configure EC with:
     ```js
     astroExpressiveCode({
       themes: ['github-dark-default'],
       styleOverrides: {
         codeBackground: 'var(--color-void)',
         borderColor: 'var(--color-border)',
         borderRadius: '4px',
         codeFontFamily: 'var(--font-code)',
         codeFontSize: '0.875rem',
         codeLineHeight: '1.6',
         codePaddingBlock: '1.25rem',
         codePaddingInline: '1.25rem',
         frames: {
           shadowColor: 'transparent',
         },
       },
     })
     ```
   - Update `mdx()` to include rehype plugins:
     ```js
     mdx({
       rehypePlugins: [
         rehypeHeadingIds,
         [rehypeAutolinkHeadings, {
           behavior: 'append',
           properties: { class: 'heading-anchor', ariaHidden: true, tabIndex: -1 },
           content: h('span.heading-anchor-icon', '#'),
         }],
       ],
     })
     ```
   - REMOVE the entire `markdown.shikiConfig` block (EC replaces it, keeping it causes conflicts).

3. Update `src/styles/global.css`:
   - REMOVE the `pre.astro-code` block (lines 149-158). EC generates its own HTML structure (`<figure>` wrapping `<pre>`), so this selector no longer matches.
   - Add heading anchor styles:
     ```css
     /* ---- HEADING ANCHORS ---- */
     .heading-anchor {
       opacity: 0;
       margin-left: 0.5rem;
       color: var(--color-text-muted);
       text-decoration: none;
       transition: opacity 0.2s ease;
     }
     .prose :is(h2, h3):hover .heading-anchor {
       opacity: 1;
     }
     .heading-anchor:hover {
       color: var(--color-teal-bright);
     }
     .heading-anchor-icon {
       font-family: var(--font-code);
       font-size: 0.8em;
     }
     ```
   - Add TOC active state styles:
     ```css
     /* ---- TOC ACTIVE STATE ---- */
     .toc-link.active {
       color: var(--color-teal-bright);
       border-color: var(--color-teal);
     }
     ```
   - Add reading progress bar style:
     ```css
     /* ---- READING PROGRESS ---- */
     #reading-progress {
       transform-origin: left;
       transition: transform 80ms linear;
     }
     ```
   - Add prose image styles (from mockup):
     ```css
     .prose img {
       border-radius: 4px;
       border: 1px solid var(--color-border);
     }
     ```
  </action>
  <verify>
Run `npm run build` -- the build must succeed with EC processing code blocks in the seed MDX articles. Check build output for "astro-expressive-code" in the integration list. No errors about conflicting Shiki config.
  </verify>
  <done>
Build passes with EC integration active. Seed article code blocks are processed by Expressive Code (copy buttons, language labels, frames). The old `pre.astro-code` CSS rule is removed. Heading anchor, TOC active, reading progress, and prose image styles are in global.css.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend article data layer and add i18n strings</name>
  <files>src/lib/articles.ts, src/i18n/ui.ts</files>
  <action>
1. Add `getRelatedArticles()` to `src/lib/articles.ts`:
   ```typescript
   export async function getRelatedArticles(
     article: Article,
     limit = 3,
   ): Promise<Article[]> {
     const allArticles = await getArticlesByLocale(article.data.lang as 'en' | 'fr');
     const otherArticles = allArticles.filter((a) => a.id !== article.id);

     const scored = otherArticles.map((a) => {
       let score = 0;
       if (a.data.category === article.data.category) score += 2;
       for (const tag of a.data.tags) {
         if (article.data.tags.includes(tag)) score += 1;
       }
       return { article: a, score };
     });

     return scored
       .sort((a, b) => b.score - a.score)
       .slice(0, limit)
       .map((s) => s.article);
   }
   ```

2. Add article page i18n keys to `src/i18n/ui.ts` in both `en` and `fr` objects:
   ```typescript
   // EN keys to add:
   "article.backToArticles": "Back to articles",
   "article.toc": "Table of contents",
   "article.share": "Share",
   "article.tags": "Tags",
   "article.relatedArticles": "Related articles",
   "article.shareTwitter": "Share on Twitter",
   "article.shareLinkedin": "Share on LinkedIn",
   "article.shareDevto": "Share on dev.to",
   "article.copyLink": "Copy link",
   "article.linkCopied": "Copied!",

   // FR keys to add:
   "article.backToArticles": "Retour aux articles",
   "article.toc": "Sommaire",
   "article.share": "Partager",
   "article.tags": "Tags",
   "article.relatedArticles": "Articles similaires",
   "article.shareTwitter": "Partager sur Twitter",
   "article.shareLinkedin": "Partager sur LinkedIn",
   "article.shareDevto": "Partager sur dev.to",
   "article.copyLink": "Copier le lien",
   "article.linkCopied": "Copie !",
   ```
  </action>
  <verify>
Run `npx astro check` -- no type errors. Verify `getRelatedArticles` is exported by checking the import resolves. Verify i18n keys are accessible: the `ui.ts` file should have matching keys in both `en` and `fr` objects.
  </verify>
  <done>
`getRelatedArticles()` is exported from `src/lib/articles.ts` and scores articles by shared category (+2) and tags (+1 each), returning up to 3 related articles. All 10 article page i18n keys exist in both EN and FR.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with Expressive Code listed in integrations output
2. Seed article code blocks render with EC features (copy button, language labels, frames)
3. `npx astro check` reports 0 errors
4. `src/lib/articles.ts` exports `getRelatedArticles`
5. `src/i18n/ui.ts` has all 10 new keys in both locales
</verification>

<success_criteria>
- astro-expressive-code is installed and configured before mdx() in integrations
- markdown.shikiConfig is removed, pre.astro-code CSS is removed
- rehype-autolink-headings configured with rehypeHeadingIds before it
- global.css has heading anchor, TOC active, reading progress, and prose image styles
- getRelatedArticles() returns scored related articles by category and tag overlap
- All article page i18n strings exist in EN and FR
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-article-page/03-01-SUMMARY.md`
</output>
