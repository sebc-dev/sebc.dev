---
phase: 03-article-page
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/article/PillarTag.astro
  - src/components/article/ArticleHeader.astro
  - src/components/article/ShareButtons.astro
  - src/components/article/TableOfContents.astro
  - src/components/article/RelatedArticles.astro
  - src/components/ui/ReadingProgress.astro
  - src/layouts/ArticleLayout.astro
  - src/pages/en/articles/[id].astro
  - src/pages/fr/articles/[id].astro
autonomous: false

must_haves:
  truths:
    - "User can read a full MDX article with Expressive Code blocks showing copy button, language labels, line highlighting, and editor frames"
    - "User can navigate article sections via a sticky TOC sidebar on desktop with scroll-spy highlighting the current section"
    - "User sees a reading progress bar at the top of the page that fills as they scroll"
    - "User can see article metadata including date, reading time, category, tags, and pillar tags with distinctive color styling"
    - "User can share the article via Twitter/X, LinkedIn, dev.to, or copy the link"
    - "User can click heading anchor links to copy section URLs"
    - "User can discover related articles at the bottom of the page"
    - "Pillar tags have distinctive visual treatment: IA=purple, Ingenierie=teal, UX=amber"
  artifacts:
    - path: "src/components/article/PillarTag.astro"
      provides: "Distinctive pillar tag badge with per-pillar colors"
      min_lines: 15
    - path: "src/components/article/ArticleHeader.astro"
      provides: "Article title, description, cover image, metadata row, pillar tags"
      min_lines: 40
    - path: "src/components/article/ShareButtons.astro"
      provides: "Social share links for Twitter, LinkedIn, dev.to, copy link"
      min_lines: 30
    - path: "src/components/article/TableOfContents.astro"
      provides: "Sticky sidebar TOC with scroll-spy and h2/h3 indentation"
      min_lines: 40
    - path: "src/components/article/RelatedArticles.astro"
      provides: "Related articles section using ArticleCard"
      min_lines: 20
    - path: "src/components/ui/ReadingProgress.astro"
      provides: "Fixed reading progress bar at top of viewport"
      min_lines: 10
    - path: "src/layouts/ArticleLayout.astro"
      provides: "Article page layout with 2-column grid, sidebar, content area"
      min_lines: 30
    - path: "src/pages/en/articles/[id].astro"
      provides: "EN dynamic article route with getStaticPaths"
      exports: ["getStaticPaths"]
    - path: "src/pages/fr/articles/[id].astro"
      provides: "FR dynamic article route with getStaticPaths"
      exports: ["getStaticPaths"]
  key_links:
    - from: "src/pages/en/articles/[id].astro"
      to: "src/layouts/ArticleLayout.astro"
      via: "imports and renders ArticleLayout with article + headings props"
      pattern: "ArticleLayout"
    - from: "src/layouts/ArticleLayout.astro"
      to: "src/components/article/TableOfContents.astro"
      via: "passes headings array to TOC component"
      pattern: "headings"
    - from: "src/layouts/ArticleLayout.astro"
      to: "src/lib/articles.ts"
      via: "calls getRelatedArticles() for related section"
      pattern: "getRelatedArticles"
    - from: "src/components/article/TableOfContents.astro"
      to: "article :is(h2, h3)"
      via: "IntersectionObserver scroll-spy on heading elements"
      pattern: "IntersectionObserver"
    - from: "src/components/ui/ReadingProgress.astro"
      to: "article element"
      via: "scroll event measuring article bounding rect"
      pattern: "getBoundingClientRect"
    - from: "src/components/article/ShareButtons.astro"
      to: "external share URLs"
      via: "URL-based share intents (no SDKs)"
      pattern: "twitter.com/intent|linkedin.com/shareArticle"
---

<objective>
Build the complete article reading experience: all article components, the ArticleLayout, and the dynamic route pages for EN and FR.

Purpose: Deliver the full article page (ARTI-01 through ARTI-08) -- the core product of the blog.
Output: Working article pages at /en/articles/{id} and /fr/articles/{id} with TOC, reading progress, sharing, heading anchors, related articles, and pillar tags.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-article-page/03-RESEARCH.md
@.planning/phases/03-article-page/03-01-SUMMARY.md
@src/layouts/BaseLayout.astro
@src/components/article/ArticleCard.astro
@src/components/ui/Tag.astro
@src/lib/articles.ts
@src/i18n/ui.ts
@src/i18n/utils.ts
@src/utils/dates.ts
@src/content.config.ts
@src/styles/global.css
@astro.config.mjs
@docs/design-research/article.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create article page components</name>
  <files>
    src/components/article/PillarTag.astro
    src/components/article/ArticleHeader.astro
    src/components/article/ShareButtons.astro
    src/components/article/TableOfContents.astro
    src/components/article/RelatedArticles.astro
    src/components/ui/ReadingProgress.astro
  </files>
  <action>
Create 6 components following the design mockup in `docs/design-research/article.html` and the patterns established in Phase 1/2.

**1. `src/components/article/PillarTag.astro`**
Props: `{ pillar: 'IA' | 'Ingenierie' | 'UX', class?: string }`
- Pillar-specific color map:
  - IA: `bg-purple-500/15 border-purple-500/30 text-purple-400`
  - Ingenierie: `bg-teal/15 border-teal/30 text-teal-bright`
  - UX: `bg-amber-500/15 border-amber-500/30 text-amber-400`
- Display as `inline-flex items-center text-xs font-code px-2.5 py-1 rounded-xs border`
- Note: The schema has pillarTags with accented "Ingenierie" (Ingenierie). Use normalized comparison -- strip accents or match both forms. The simpler approach: use the raw pillarTag value as display text, match against a map that handles both "Ingenierie" and "Ingenierie" forms.

**2. `src/components/article/ArticleHeader.astro`**
Props: `{ article: Article }`
- Back link: arrow SVG + `t("article.backToArticles")`, links to `/${lang}` (home page)
- Cover image with category badge (reuse the pattern from ArticleCard: image with gradient overlay, category span positioned absolute top-left). If no image, skip the image container entirely.
- Title as `<h1>` with `text-3xl md:text-4xl lg:text-5xl font-bold leading-[1.15] tracking-tight`
- Description as `<p>` with `text-lg text-text-secondary leading-relaxed max-w-2xl`
- Metadata row below title with border-bottom: date (calendar SVG icon + formatted date), reading time (clock SVG icon + readingTime + t("article.readingTime")), pillar tags row using PillarTag component
- Tags below metadata using the existing Tag component
- Follow the mockup header structure (back link -> image -> h1 -> description -> metadata row with border-b)

**3. `src/components/article/ShareButtons.astro`**
Props: `{ url: string, title: string }`
- Section heading: `t("article.share")` as `text-xs font-semibold uppercase tracking-widest text-text-muted`
- 4 buttons in a `flex gap-2`:
  - Twitter/X: `<a>` with `target="_blank" rel="noopener noreferrer"` and SVG icon. URL: `https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(url)}`
  - LinkedIn: same pattern. URL: `https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}`
  - dev.to: same pattern. URL: `https://dev.to/new?prefill=${encodeURIComponent('---\ntitle: ' + title + '\npublished: false\n---\n\nOriginally posted at ' + url)}`
  - Copy link: `<button>` with `data-copy-url={url}` attribute. Add inline `<script>` using the project pattern (direct call + astro:after-swap) that listens for clicks on `[data-copy-url]`, copies URL to clipboard, shows "Copied!" feedback by temporarily changing the button's aria-label and adding a visual indicator.
- Each button: `w-9 h-9 flex items-center justify-center rounded-xs border border-border text-text-muted hover:text-teal hover:border-teal/30 transition-colors`
- Use aria-labels from i18n: `t("article.shareTwitter")`, etc.

**4. `src/components/article/TableOfContents.astro`**
Props: `{ headings: { depth: number, slug: string, text: string }[] }`
- Filter to only h2 and h3 (`depth === 2 || depth === 3`)
- Section heading: `t("article.toc")` as `text-xs font-semibold uppercase tracking-widest text-text-muted mb-4`
- Render as `<nav><ul class="space-y-1">` with each heading as:
  - `<a href="#{slug}" data-toc-link class="toc-link block text-sm text-text-muted hover:text-text-primary py-1.5 border-l-2 border-border transition-colors">`
  - h2: `pl-3`, h3: `pl-5` (indented)
- Add inline `<script>` with scroll-spy using IntersectionObserver:
  ```
  function initScrollSpy() {
    const headings = document.querySelectorAll('article :is(h2, h3)');
    const tocLinks = document.querySelectorAll('[data-toc-link]');
    if (!headings.length || !tocLinks.length) return;

    const observer = new IntersectionObserver(
      (entries) => {
        for (const entry of entries) {
          if (entry.isIntersecting) {
            tocLinks.forEach((link) => link.classList.remove('active'));
            const id = entry.target.getAttribute('id');
            const activeLink = document.querySelector(`[data-toc-link][href="#${id}"]`);
            activeLink?.classList.add('active');
          }
        }
      },
      { threshold: 1, rootMargin: '-80px 0px -66% 0px' }
    );

    headings.forEach((heading) => observer.observe(heading));
  }
  initScrollSpy();
  document.addEventListener('astro:after-swap', initScrollSpy);
  ```
  The rootMargin `-80px` accounts for the sticky header (h-16 = 64px + padding).
- Hide on mobile: the entire component renders but the sidebar container in ArticleLayout handles `hidden lg:block`.

**5. `src/components/article/RelatedArticles.astro`**
Props: `{ articles: Article[] }`
- Only render if `articles.length > 0`
- Wrapper: `<section class="mt-16 pt-12 border-t border-border">`
- Heading: `t("article.relatedArticles")` as `text-sm font-semibold uppercase tracking-widest text-text-muted mb-8`
- Grid: `grid grid-cols-1 sm:grid-cols-2 gap-6` -- reuse the existing `ArticleCard` component for each article
- Maximum 2 columns for related articles (not 3 like the home page grid)

**6. `src/components/ui/ReadingProgress.astro`**
No props needed.
- Fixed bar at very top of viewport: `<div id="reading-progress" class="fixed top-0 left-0 z-[60] h-0.5 w-full bg-teal" style="transform: scaleX(0)"></div>`
- The z-[60] places it above the sticky header (z-50).
- Add inline `<script>` with the project pattern:
  ```
  function initReadingProgress() {
    const bar = document.getElementById('reading-progress');
    const article = document.querySelector('article');
    if (!bar || !article) return;

    function updateProgress() {
      const rect = article.getBoundingClientRect();
      const articleTop = rect.top + window.scrollY;
      const articleHeight = rect.height;
      const scrolled = window.scrollY - articleTop;
      const progress = Math.min(Math.max(scrolled / (articleHeight - window.innerHeight), 0), 1);
      bar.style.transform = `scaleX(${progress})`;
    }

    window.addEventListener('scroll', updateProgress, { passive: true });
    updateProgress();
  }
  initReadingProgress();
  document.addEventListener('astro:after-swap', initReadingProgress);
  ```
  Uses `scaleX` transform (GPU-accelerated) instead of width for better performance. `passive: true` on scroll listener to avoid jank.
  </action>
  <verify>
Run `npx astro check` -- 0 errors. All 6 component files exist and have valid Astro component syntax. Each component imports its dependencies correctly (Article type, Tag component, i18n utils, etc.).
  </verify>
  <done>
6 article components created: PillarTag (3-color pillar badges), ArticleHeader (back link, image, title, metadata, pillar tags), ShareButtons (Twitter/LinkedIn/dev.to/copy with URL intents), TableOfContents (scroll-spy TOC with h2/h3 indentation), RelatedArticles (2-col grid of ArticleCards), ReadingProgress (fixed scaleX progress bar).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ArticleLayout and dynamic route pages</name>
  <files>
    src/layouts/ArticleLayout.astro
    src/pages/en/articles/[id].astro
    src/pages/fr/articles/[id].astro
  </files>
  <action>
**1. `src/layouts/ArticleLayout.astro`**
Props: `{ article: Article, headings: { depth: number, slug: string, text: string }[] }`
- Import BaseLayout, ArticleHeader, TableOfContents, ShareButtons, RelatedArticles, ReadingProgress, Tag
- Import `getRelatedArticles` from `@/lib/articles`
- Import `getLangFromUrl, useTranslations` from `@/i18n/utils`
- Get `lang` from `Astro.url`, get translations `t`
- Compute `relatedArticles` by calling `await getRelatedArticles(article)`
- Compute `articleUrl` as the full canonical URL: `Astro.site + Astro.url.pathname` (or `new URL(Astro.url.pathname, Astro.site).href`)
- Structure (wrapping BaseLayout with article title and description):
  ```
  <BaseLayout title={article.data.title} description={article.data.description}>
    <ReadingProgress />
    <div class="max-w-6xl mx-auto px-6 lg:px-8 py-12 md:py-16">
      <div class="lg:grid lg:grid-cols-[1fr_240px] lg:gap-12">
        <article>
          <ArticleHeader article={article} />
          <div class="prose max-w-none" id="article-content">
            <slot />
          </div>
          <RelatedArticles articles={relatedArticles} />
        </article>
        <aside class="hidden lg:block">
          <div class="sticky top-24">
            <TableOfContents headings={headings} />
            <div class="mt-8">
              <h3 class="text-xs font-semibold uppercase tracking-widest text-text-muted mb-4">{t("article.tags")}</h3>
              <div class="flex flex-wrap gap-2">
                {article.data.tags.map((tag) => <Tag label={tag} />)}
              </div>
            </div>
            <div class="mt-8">
              <ShareButtons url={articleUrl} title={article.data.title} />
            </div>
          </div>
        </aside>
      </div>
    </div>
  </BaseLayout>
  ```
- Add a `<script>` for heading anchor copy behavior (ARTI-06): intercept clicks on `.heading-anchor` links, copy the full URL (with hash) to clipboard, show brief visual feedback (add a temporary CSS class or tooltip), AND update the URL hash (so both copy and navigate happen). Use the project pattern (direct call + astro:after-swap):
  ```
  function initHeadingAnchorCopy() {
    document.querySelectorAll('.heading-anchor').forEach((anchor) => {
      anchor.addEventListener('click', async (e) => {
        e.preventDefault();
        const hash = anchor.getAttribute('href');
        const url = window.location.origin + window.location.pathname + hash;
        await navigator.clipboard.writeText(url);
        // Update URL hash for navigation
        window.history.pushState(null, '', hash);
        // Visual feedback
        anchor.classList.add('text-teal-bright');
        setTimeout(() => anchor.classList.remove('text-teal-bright'), 1500);
      });
    });
  }
  initHeadingAnchorCopy();
  document.addEventListener('astro:after-swap', initHeadingAnchorCopy);
  ```

**2. `src/pages/en/articles/[id].astro`**
- Import `getCollection, render` from `astro:content`
- Import `ArticleLayout` from `@/layouts/ArticleLayout.astro`
- `getStaticPaths`: filter articles by `entry.data.lang === 'en'` and `!entry.data.draft`, map to `{ params: { id: article.id }, props: { article } }`
- In the component body: `const { article } = Astro.props`, `const { Content, headings } = await render(article)`
- Render: `<ArticleLayout article={article} headings={headings}><Content /></ArticleLayout>`

**3. `src/pages/fr/articles/[id].astro`**
- Identical structure to EN version but filter by `entry.data.lang === 'fr'`
  </action>
  <verify>
Run `npm run build` -- build must succeed, generating pages for all 6 seed articles (3 EN + 3 FR). Check the build output shows routes like `/en/articles/en-building-design-system` and `/fr/articles/fr-construire-design-system`. Run `npm run dev` and visit `http://localhost:4321/en/articles/en-building-design-system` -- the article page should render with header, content, TOC sidebar, and related articles.
  </verify>
  <done>
ArticleLayout wraps BaseLayout with 2-column article grid (content + sidebar). Dynamic route pages at `/en/articles/[id]` and `/fr/articles/[id]` use getStaticPaths to generate pages per locale. Heading anchor links copy URLs to clipboard. Article pages render MDX content with all sidebar elements.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete article reading experience with:
- Full MDX article rendering with Expressive Code blocks (copy button, language labels, editor/terminal frames)
- Sticky TOC sidebar on desktop with scroll-spy highlighting
- Reading progress bar at top of viewport
- Article metadata: date, reading time, category, tags, pillar tags (IA=purple, Ingenierie=teal, UX=amber)
- Share buttons (Twitter/X, LinkedIn, dev.to, copy link)
- Heading anchor links that copy section URLs on click
- Related articles at bottom using ArticleCard component
  </what-built>
  <how-to-verify>
1. Run `npm run dev` and visit `http://localhost:4321/en/articles/en-building-design-system`
2. **Reading progress (ARTI-03):** Scroll down -- teal progress bar at very top of viewport should fill proportionally
3. **Article header (ARTI-04):** Verify back link, cover image with category badge, title, description, metadata (date, reading time), pillar tags with colors (purple/teal/amber)
4. **Code blocks (ARTI-01):** Scroll to code blocks -- verify copy button works, language labels display, editor frames show
5. **TOC sidebar (ARTI-02):** On desktop (>= 1024px), verify sticky TOC on right. Scroll through article -- current section should highlight in teal in the TOC
6. **Heading anchors (ARTI-06):** Hover over an h2 heading -- "#" anchor should appear. Click it -- URL should update and link should be copied to clipboard
7. **Share buttons (ARTI-05):** In sidebar, click Twitter share button -- should open tweet intent in new tab. Click copy link button -- should copy URL
8. **Related articles (ARTI-07):** Scroll to bottom -- 2-column grid of related article cards
9. **Pillar tags (ARTI-08):** Verify IA is purple, Ingenierie is teal, UX is amber
10. **FR version:** Visit `http://localhost:4321/fr/articles/fr-construire-design-system` -- verify French labels (Sommaire, Partager, Articles similaires, Retour aux articles)
11. **Mobile:** Resize to mobile width -- TOC sidebar should be hidden, article takes full width, reading progress bar still visible
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. All 9 new files exist and are valid Astro components/pages
2. `npm run build` passes with all 6 article pages generated
3. Article pages render MDX content with EC code blocks
4. TOC scroll-spy highlights active section on scroll
5. Reading progress bar fills proportionally on scroll
6. Share buttons open correct URLs, copy link works
7. Heading anchors copy section URL to clipboard on click
8. Related articles show at bottom with matching category/tags
9. Pillar tags display with correct per-pillar colors
10. All labels display correctly in both EN and FR
</verification>

<success_criteria>
- ARTI-01: Code blocks have copy button, language labels, line highlighting, editor frames via EC
- ARTI-02: Desktop sticky TOC sidebar with scroll-spy highlighting
- ARTI-03: Reading progress bar at top fills on scroll
- ARTI-04: Article metadata visible (date, reading time, category, tags, pillar tags)
- ARTI-05: Share via Twitter/X, LinkedIn, dev.to, copy link all functional
- ARTI-06: Heading anchors copy section URLs to clipboard
- ARTI-07: Related articles at bottom matched by tags/category
- ARTI-08: Pillar tags with distinctive colors (purple, teal, amber)
- Both EN and FR article pages render with correct locale labels
</success_criteria>

<output>
After completion, create `.planning/phases/03-article-page/03-02-SUMMARY.md`
</output>
