---
phase: 04-search-page
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/layouts/ArticleLayout.astro
  - src/lib/articles.ts
  - src/i18n/ui.ts
autonomous: true

must_haves:
  truths:
    - "Article pages have data-pagefind-body on the article element so Pagefind indexes article content only"
    - "Article pages expose category and tag filters via data-pagefind-filter attributes"
    - "Article pages expose title, description, date, readingTime, image, and url as data-pagefind-meta"
    - "Search pages have data-pagefind-ignore so they do not appear in their own search results"
    - "getTags() returns all unique tags for a locale sorted alphabetically"
    - "Search-related i18n strings exist in both EN and FR"
  artifacts:
    - path: "src/layouts/ArticleLayout.astro"
      provides: "Pagefind indexing attributes on article element"
      contains: "data-pagefind-body"
    - path: "src/lib/articles.ts"
      provides: "getTags helper for filter sidebar"
      exports: ["getTags"]
    - path: "src/i18n/ui.ts"
      provides: "Search page translation strings"
      contains: "search."
  key_links:
    - from: "src/layouts/ArticleLayout.astro"
      to: "pagefind index"
      via: "data-pagefind-body, data-pagefind-filter, data-pagefind-meta attributes"
      pattern: "data-pagefind-(body|filter|meta)"
    - from: "src/lib/articles.ts"
      to: "src/content.config.ts"
      via: "getCollection with tag extraction"
      pattern: "getTags"
---

<objective>
Instrument article pages for Pagefind indexing and prepare the data layer and i18n strings needed by the search page.

Purpose: Pagefind requires data-pagefind-body, data-pagefind-filter, and data-pagefind-meta attributes on article pages to produce useful search results with category/tag filtering and rich metadata. The search page also needs a getTags() helper and i18n strings.

Output: ArticleLayout with full Pagefind instrumentation, getTags() helper in articles.ts, search-related i18n strings in ui.ts.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-search-page/04-RESEARCH.md
@src/layouts/ArticleLayout.astro
@src/lib/articles.ts
@src/i18n/ui.ts
@src/content.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Instrument ArticleLayout with Pagefind attributes</name>
  <files>src/layouts/ArticleLayout.astro</files>
  <action>
Add Pagefind indexing attributes to ArticleLayout.astro:

1. On the existing `<article>` element, add `data-pagefind-body` attribute. This opts article pages into Pagefind indexing (once any page has data-pagefind-body, pages without it are excluded from the index).

2. Inside the `<article>` element (before ArticleHeader), add `<meta>` tags for Pagefind filters and metadata:

Filters (one meta per value):
- `<meta data-pagefind-filter="category[content]" content={article.data.category} />`
- Map over `article.data.tags` to produce one `<meta data-pagefind-filter="tag[content]" content={tag} />` per tag

Metadata (one meta per field):
- `<meta data-pagefind-meta="title[content]" content={article.data.title} />`
- `<meta data-pagefind-meta="description[content]" content={article.data.description} />`
- `<meta data-pagefind-meta="date[content]" content={article.data.date.toISOString()} />`
- `<meta data-pagefind-meta="readingTime[content]" content={String(article.data.readingTime)} />`
- `<meta data-pagefind-meta="image[content]" content={article.data.image || ""} />`
- `<meta data-pagefind-meta="url[content]" content={getArticleUrl(article)} />`

Import `getArticleUrl` from `@/lib/articles` (already imported via type Article, just add to the import).

3. On the search page placeholder content (both en/search.astro and fr/search.astro), add `data-pagefind-ignore` to the main section element so the search page doesn't appear in its own results. This will be done properly when the search page is rebuilt in Plan 02, but for now just note that the search page must have this attribute.

IMPORTANT: The `<article>` tag already exists on line 46 of ArticleLayout.astro. Add `data-pagefind-body` to that existing tag. Place the meta tags right after the opening `<article>` tag and before `<ArticleHeader>`.
  </action>
  <verify>
Run `npm run build` and check that the build succeeds. Then verify the built HTML contains the Pagefind attributes:
- `grep -l "data-pagefind-body" dist/en/articles/*/index.html | head -3` should find article pages
- `grep "data-pagefind-filter" dist/en/articles/en-css-container-queries/index.html` should show category and tag filters
- `grep "data-pagefind-meta" dist/en/articles/en-css-container-queries/index.html` should show title, description, date, readingTime, image, url metadata
  </verify>
  <done>All article pages have data-pagefind-body on the article element, data-pagefind-filter for category and each tag, and data-pagefind-meta for title, description, date, readingTime, image, and url.</done>
</task>

<task type="auto">
  <name>Task 2: Add getTags helper and search i18n strings</name>
  <files>src/lib/articles.ts, src/i18n/ui.ts</files>
  <action>
1. In `src/lib/articles.ts`, add a `getTags()` function:

```typescript
export async function getTags(lang: "en" | "fr"): Promise<string[]> {
  const articles = await getArticlesByLocale(lang);
  const tags = [...new Set(articles.flatMap((a) => a.data.tags))];
  return tags.sort();
}
```

This follows the same pattern as the existing `getCategories()` function.

2. In `src/i18n/ui.ts`, add search-related translation keys to both the `en` and `fr` objects:

English keys:
- `"search.title": "Search"`
- `"search.description": "Search articles on sebc.dev"`
- `"search.placeholder": "Search articles..."`
- `"search.noResults": "No results for"`
- `"search.allArticles": "All articles"`
- `"search.filters": "Filters"`
- `"search.categories": "Categories"`
- `"search.tags": "Tags"`
- `"search.clearAll": "Clear all"`
- `"search.gridView": "Grid view"`
- `"search.listView": "List view"`
- `"search.resultCount": "results"`
- `"search.resultCountSingular": "result"`
- `"search.loading": "Loading search..."`

French keys:
- `"search.title": "Recherche"`
- `"search.description": "Rechercher des articles sur sebc.dev"`
- `"search.placeholder": "Rechercher des articles..."`
- `"search.noResults": "Aucun résultat pour"`
- `"search.allArticles": "Tous les articles"`
- `"search.filters": "Filtres"`
- `"search.categories": "Catégories"`
- `"search.tags": "Tags"`
- `"search.clearAll": "Tout effacer"`
- `"search.gridView": "Vue grille"`
- `"search.listView": "Vue liste"`
- `"search.resultCount": "résultats"`
- `"search.resultCountSingular": "résultat"`
- `"search.loading": "Chargement de la recherche..."`
  </action>
  <verify>
Run `npx vitest run` to confirm existing tests still pass. Run `npx astro check` (or `npm run typecheck`) to verify no type errors from the new exports and i18n keys.
  </verify>
  <done>getTags() is exported from articles.ts and returns sorted unique tags for a locale. All search-related i18n strings exist in both EN and FR in ui.ts.</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds without errors
2. Built article HTML contains data-pagefind-body, data-pagefind-filter (category + tags), and data-pagefind-meta (title, description, date, readingTime, image, url)
3. `npx vitest run` -- all existing tests pass
4. `npm run typecheck` -- no type errors
5. getTags() is properly exported and returns string[]
</verification>

<success_criteria>
- ArticleLayout has data-pagefind-body on the article element
- Category and tag filters are exposed via data-pagefind-filter meta tags
- Six metadata fields (title, description, date, readingTime, image, url) are exposed via data-pagefind-meta
- getTags() helper exists in articles.ts with same pattern as getCategories()
- 14 search-related i18n keys exist in both EN and FR
- Build and tests pass cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04-search-page/04-01-SUMMARY.md`
</output>
