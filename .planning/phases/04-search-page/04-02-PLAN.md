---
phase: 04-search-page
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/pages/en/search.astro
  - src/pages/fr/search.astro
autonomous: true

must_haves:
  truths:
    - "User can type in a search field and see full-text search results rendered in the site's design system"
    - "User can filter search results by category and tags via a left sidebar"
    - "User can toggle between grid and list views for search results"
    - "User can see active filter chips above results and remove individual filters by clicking the x"
    - "Initial page state shows all articles in a grid with no query and no filters"
    - "URL syncs with search state via q, cat, tags query params"
    - "On mobile, sidebar becomes a drawer triggered by a Filtres/Filters button"
    - "On mobile, grid/list toggle is hidden and list mode is forced"
    - "Pagefind searches are debounced and results sorted by relevance"
    - "Search terms are highlighted in result excerpts"
    - "Filter counts show number of articles per category/tag"
    - "Empty results show 'No results for X' message"
  artifacts:
    - path: "src/pages/en/search.astro"
      provides: "English search page with full Pagefind integration"
      min_lines: 200
    - path: "src/pages/fr/search.astro"
      provides: "French search page with full Pagefind integration"
      min_lines: 200
  key_links:
    - from: "src/pages/en/search.astro"
      to: "/pagefind/pagefind.js"
      via: "dynamic import with variable indirection"
      pattern: "import.*pagefind"
    - from: "src/pages/en/search.astro"
      to: "src/lib/articles.ts"
      via: "server-rendered initial articles"
      pattern: "getArticlesByLocale"
    - from: "src/pages/en/search.astro"
      to: "URL query params"
      via: "readStateFromUrl / writeStateToUrl"
      pattern: "URLSearchParams"
---

<objective>
Build the complete search page with server-rendered initial state, Pagefind-powered full-text search, category/tag filtering with sidebar, grid/list toggle, active filter chips, URL state sync, and responsive mobile drawer.

Purpose: This is the core search experience. Users need to browse all articles (initial state), search by keyword, filter by category and tags, toggle views, and share search states via URL. The page uses Pagefind's JS API (not the default widget) to maintain the site's custom design system.

Output: Complete EN and FR search pages with all search functionality.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-search-page/04-RESEARCH.md
@.planning/phases/04-search-page/04-01-SUMMARY.md
@src/components/article/ArticleCard.astro
@src/components/ui/Tag.astro
@src/lib/articles.ts
@src/i18n/ui.ts
@src/i18n/utils.ts
@src/layouts/BaseLayout.astro
@src/layouts/ArticleLayout.astro
@src/pages/en/index.astro
@src/styles/global.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build EN search page with complete search UI and client-side behavior</name>
  <files>src/pages/en/search.astro</files>
  <action>
Replace the placeholder search page with the full search implementation. The page has two major parts: Astro frontmatter + HTML layout, and a `<script>` tag with all client-side behavior.

**Astro Frontmatter:**
- Import BaseLayout, ArticleCard, getArticlesByLocale, getCategories, getTags, getLangFromUrl, useTranslations
- Get lang from URL, translations via t()
- Fetch all articles, categories, tags for server-rendered initial state
- Compute initial filter counts: for each category, count articles with that category; for each tag, count articles that include that tag

**HTML Structure:**
Add `data-pagefind-ignore` attribute on the outermost content section (prevents search page from appearing in its own results).

Layout: `max-w-6xl mx-auto px-6 lg:px-8 py-12 md:py-16`

1. **Page header:** h1 with translated "Search" title

2. **Search input:** Full-width text input styled to match design system. `id="search-input"`, `type="search"`, placeholder from i18n. Styling: `bg-surface border border-border rounded-xs px-4 py-3 text-text-primary placeholder:text-text-muted focus:outline-none focus:border-teal/50 w-full font-body`. No submit button (instant search).

3. **Active filter chips area:** `id="filter-chips"`, a flex-wrap row below the search input. Initially empty. Chips will be injected by JS. Each chip: `inline-flex items-center gap-1.5 text-xs font-code px-2.5 py-1 rounded-xs border text-teal-bright border-teal/20 bg-teal-dim`. Each chip has an x button (`data-remove-filter`) and text label. Include a "Clear all" link when any filters are active.

4. **Main content area:** `lg:grid lg:grid-cols-[240px_1fr] lg:gap-8`

   **Left sidebar** (`id="filter-sidebar"`, `hidden lg:block`):
   - Categories section: h3 "Categories", list of buttons. Each button: `data-filter-category="{value}"`, shows category name + count in parentheses. Styled similar to CategoryFilter: text-sm, border, rounded-xs. Active state: `text-teal-bright border-teal bg-teal-dim`.
   - Tags section: h3 "Tags", list of buttons. Each button: `data-filter-tag="{value}"`, shows tag name + count. Same styling as categories.
   - Server-render the initial filter buttons with counts from Astro data.

   **Mobile filter button:** `lg:hidden`, shows "Filters" with filter icon, triggers drawer. `id="filter-mobile-btn"`.

   **Mobile filter drawer:** Same overlay+panel pattern as ArticleLayout's mobile TOC. Overlay `id="filter-drawer-overlay"` with backdrop blur. Panel slides in from left (`-translate-x-full` initially). Contains same category and tag filter buttons as sidebar. Close button + backdrop click to dismiss.

   **Results area** (right column on desktop, full width on mobile):
   - **View toggle + result count bar:** Flex row with result count on left (`id="result-count"`) and grid/list toggle buttons on right (`id="view-toggle"`, `hidden lg:flex`). Grid icon and list icon as inline SVGs. Active toggle button gets teal treatment.
   - **Server-rendered articles grid:** `id="initial-articles"`, `grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6`. Map over all articles and render ArticleCard for each. This is shown as the initial state.
   - **Pagefind results container:** `id="search-results"`, initially `class="hidden"`. Client-side JS populates this.
   - **No results message:** `id="no-results"`, initially `class="hidden"`. Shows "No results for" + query.
   - **Loading state:** `id="search-loading"`, initially `class="hidden"`. Shows "Loading search..." with a pulse animation.

**Client-Side Script (`<script>` tag):**

Follow the init pattern: define `initSearch()` function, call immediately, listen for `astro:after-swap`.

Inside `initSearch()`:

a) **State management:**
   - `SearchState` interface: `{ query: string, category: string, tags: string[], view: "grid" | "list" }`
   - `readStateFromUrl()`: Read q, cat, tags from URLSearchParams
   - `writeStateToUrl(state, push)`: Write state to URL. Use `replaceState` for typing, `pushState` for filter clicks.
   - Read initial state from URL on load

b) **Pagefind initialization:**
   - Lazy init on first interaction (focus on search input or filter click)
   - Variable indirection for import: `const pagefindPath = "/pagefind/pagefind.js"; await import(/* @vite-ignore */ pagefindPath);`
   - Wrap in try/catch for dev mode graceful fallback
   - Call `pagefind.init()` after import
   - Store reference in closure variable

c) **Search execution (`performSearch`):**
   - If no query and no filters: show `#initial-articles`, hide `#search-results`, update result count from initial article count, return
   - Otherwise: hide `#initial-articles`, show `#search-results`
   - Build Pagefind filter object: `{ category: state.category }` if set, `{ tag: { any: state.tags } }` if tags set
   - Call `pf.debouncedSearch(query || null, { filters }, 250)`
   - If result is null (superseded), return
   - Load result data: `await Promise.all(result.results.map(r => r.data()))`
   - Render results using `renderGridCard()` or `renderListCard()` depending on view mode
   - Update filter counts from `result.totalFilters` if available
   - Update result count display
   - Show `#no-results` if zero results

d) **Result rendering:**
   - `renderGridCard(data, lang)`: Produce HTML matching ArticleCard.astro's markup exactly. Use the same Tailwind classes. Handle image fallback with >_ placeholder. Format date with `Intl.DateTimeFormat`. Show category badge, date, reading time, title, excerpt (with Pagefind `<mark>` tags for highlighting), tags. Wrap in `<article class="group">` with `<a>` link.
   - `renderListCard(data, lang)`: Horizontal layout. `flex gap-4` with thumbnail on left (aspect-video, w-48 on desktop) and content on right. Same metadata as grid but in horizontal flow. Title, excerpt with highlights, category/tags/date/reading-time in a metadata row.
   - `escapeHtml(str)`: Utility to prevent XSS in template literals.
   - Use `data.excerpt` (which has `<mark>` tags from Pagefind) for the description/excerpt field. Use `data.meta.title` for the title. For title highlighting, extract marked terms from excerpt and apply to title text.

e) **Filter handling:**
   - Category buttons: click toggles active state (click same = deselect). Update state.category, push to URL, re-run search.
   - Tag buttons: click toggles on/off. Multiple can be active (OR logic). Update state.tags, push to URL, re-run search.
   - Update filter button visual states (active = teal treatment, inactive = default border)
   - Sync mobile drawer filter buttons with sidebar filter buttons (same data, same state)

f) **Filter chips:**
   - Render active filters as chips in `#filter-chips` area
   - Each chip: category or tag label with x button
   - Click x: remove that filter, push to URL, re-run search
   - "Clear all" link: clear all filters, push to URL, re-run search

g) **View toggle:**
   - Store view mode in state (default: "grid")
   - Click grid/list buttons to toggle
   - Re-render current results in selected view mode
   - On mobile (< lg breakpoint), force list view regardless of toggle
   - Use `window.matchMedia("(min-width: 1024px)")` to detect

h) **Mobile drawer:**
   - Reuse the same open/close pattern from ArticleLayout's mobile TOC
   - `filter-mobile-btn` click: open drawer
   - Backdrop click or close button: close drawer
   - Lock body scroll when open
   - Panel slides from left: `-translate-x-full` -> `translate-x-0`

i) **URL sync:**
   - On page load: read URL params, apply state (set input value, activate filters, trigger search if params exist)
   - On typing: debounce via Pagefind's debouncedSearch, replaceState
   - On filter click: pushState
   - On popstate: read URL and apply state

j) **Filter count updates:**
   - Initial state: use server-rendered counts (from Astro data)
   - After Pagefind search: update counts from `result.totalFilters` object
   - Format: "Category (N)" where N is the count
   - Use `data-count` attribute on filter buttons for easy update

k) **Reading time label:** Use the lang to determine "min read" vs "min de lecture".

The lang value is available from the HTML: `document.documentElement.lang`.
  </action>
  <verify>
Run `npm run build` to confirm the page builds without errors. Check that `dist/en/search/index.html` exists and contains the expected structure:
- `data-pagefind-ignore` attribute
- `id="search-input"` element
- `id="initial-articles"` grid with article cards
- `id="search-results"` container
- `id="filter-sidebar"` with category and tag buttons
- Filter drawer markup for mobile
- Script tag with Pagefind initialization code
  </verify>
  <done>EN search page renders all articles in initial state, has search input, sidebar filters with counts, filter chips area, grid/list toggle, mobile drawer, and complete client-side Pagefind integration with URL sync.</done>
</task>

<task type="auto">
  <name>Task 2: Create FR search page and verify both locales</name>
  <files>src/pages/fr/search.astro</files>
  <action>
The FR search page is structurally identical to the EN version. The differences are:
- `title={t("search.title")}` and `description={t("search.description")}` use the FR translations
- All server-rendered content uses FR articles from `getArticlesByLocale("fr")`
- The i18n strings (t() calls) automatically resolve to French
- Pagefind will load the FR index because `<html lang="fr">` is set by BaseLayout

Copy the EN search page to FR. The only change needed is in the frontmatter: the lang will be "fr" automatically from `getLangFromUrl(Astro.url)` since the page lives at `/fr/search`.

If the script tag references the lang, it should read it from `document.documentElement.lang` (which BaseLayout sets correctly), NOT hardcode it.

Verify both pages share the same client-side code without language-specific hardcoding. The script uses `document.documentElement.lang` for all locale-dependent behavior (date formatting, reading time label).

After creating the FR page, run `npm run build` and verify:
- Both `dist/en/search/index.html` and `dist/fr/search/index.html` exist
- FR page has French translations in the server-rendered content
- Both pages have the same script tag structure
  </action>
  <verify>
Run `npm run build` successfully. Verify:
- `dist/fr/search/index.html` exists
- French content: `grep "Recherche" dist/fr/search/index.html` returns matches
- Both pages have Pagefind integration: `grep "pagefind" dist/en/search/index.html dist/fr/search/index.html`
- Run `npm run lint` to check for any ESLint issues
  </verify>
  <done>FR search page exists, uses French translations, loads FR Pagefind index, and is structurally identical to the EN version. Both pages build cleanly.</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds -- both search pages build
2. EN search page at `dist/en/search/index.html` contains full search UI structure
3. FR search page at `dist/fr/search/index.html` contains French translations
4. Both pages have `data-pagefind-ignore` to exclude from search results
5. Server-rendered initial state shows all articles in grid
6. Client-side script initializes Pagefind with variable indirection import
7. URL params (q, cat, tags) are read on load and written on interaction
8. `npm run lint` passes
9. `npm run typecheck` passes
</verification>

<success_criteria>
- SRCH-01: Full-text search via Pagefind JS API with custom rendering (not default widget)
- SRCH-02: Category and tag sidebar filters with counts, AND between category/tags, OR within tags
- SRCH-03: Grid/list toggle on desktop, forced list on mobile
- SRCH-04: Active filter chips with individual remove and clear all
- Initial state shows all articles in grid (browsable index)
- Instant search-as-you-type with 250ms debounce
- Search terms highlighted in excerpts via Pagefind <mark> tags
- Sort by Pagefind relevance (no user toggle)
- URL sync via q/cat/tags params with replaceState for typing, pushState for filters
- Mobile drawer for filters at < lg breakpoint
- Empty results show localized "No results for X" message
- Pagefind init wrapped in try/catch for dev mode
</success_criteria>

<output>
After completion, create `.planning/phases/04-search-page/04-02-SUMMARY.md`
</output>
