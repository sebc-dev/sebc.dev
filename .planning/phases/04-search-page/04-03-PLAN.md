---
phase: 04-search-page
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - src/components/article/ArticleCard.astro
  - src/components/article/ArticleHeader.astro
  - src/components/ui/Tag.astro
autonomous: false

must_haves:
  truths:
    - "User clicks a category badge on an article card and arrives on search page with that category pre-applied as a filter"
    - "User clicks a tag on an article page and arrives on search page with that tag pre-applied as a filter"
    - "Pre-applied filter params (cat, tags) work correctly in the URL and the search page initializes with them"
    - "Full search experience works end-to-end: browse, search, filter, toggle views, share URLs"
  artifacts:
    - path: "src/components/article/ArticleCard.astro"
      provides: "Category badge links to search with ?cat= param"
      contains: "cat="
    - path: "src/components/ui/Tag.astro"
      provides: "Tag component can optionally link to search with ?tags= param"
      contains: "tags="
  key_links:
    - from: "src/components/article/ArticleCard.astro"
      to: "src/pages/{en,fr}/search.astro"
      via: "category badge href with ?cat= query param"
      pattern: "search\\?cat="
    - from: "src/components/ui/Tag.astro"
      to: "src/pages/{en,fr}/search.astro"
      via: "tag href with ?tags= query param"
      pattern: "search\\?tags="
---

<objective>
Make category badges and tags across the site link to the search page with pre-applied filters, then verify the full search experience visually.

Purpose: SRCH-05 requires users to arrive on the search page with pre-applied filters when clicking a category or tag link from any page. This enables deep-linking into filtered search results from article cards, article headers, and anywhere tags appear.

Output: Updated ArticleCard, Tag, and ArticleHeader components that link to search with pre-applied filters. Visual verification of the complete search experience.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-search-page/04-RESEARCH.md
@.planning/phases/04-search-page/04-02-SUMMARY.md
@src/components/article/ArticleCard.astro
@src/components/article/ArticleHeader.astro
@src/components/ui/Tag.astro
@src/lib/articles.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add search pre-filter links to category badges and tags</name>
  <files>src/components/article/ArticleCard.astro, src/components/ui/Tag.astro, src/components/article/ArticleHeader.astro</files>
  <action>
**1. ArticleCard.astro -- Category badge links to search:**

The category badge is currently a `<span>` inside the article card's `<a>` link. To make the category badge link to search with a pre-applied filter, wrap it in its own `<a>` tag that navigates to `/{lang}/search?cat={category}`.

However, this creates a nested `<a>` problem (badge `<a>` inside card `<a>`). To solve this:
- Keep the card's outer `<a>` link to the article
- Make the category badge a separate `<a>` element with `position: relative; z-index: 10` so it sits above the card link
- Use `e.stopPropagation()` is not needed since the badge is a real link -- just ensure it has higher z-index
- Add `href={/${lang}/search?cat=${encodeURIComponent(article.data.category)}}` to the badge

Change the category badge from:
```html
<span class="absolute top-3 left-3 text-xs font-code text-teal bg-canvas/80 backdrop-blur-sm px-2.5 py-1 rounded-xs border border-teal/20">
  {article.data.category}
</span>
```
to:
```html
<a href={`/${lang}/search?cat=${encodeURIComponent(article.data.category)}`}
   class="absolute top-3 left-3 z-10 text-xs font-code text-teal bg-canvas/80 backdrop-blur-sm px-2.5 py-1 rounded-xs border border-teal/20 hover:bg-canvas/90 transition-colors"
   onclick="event.stopPropagation()">
  {article.data.category}
</a>
```

Note: `onclick="event.stopPropagation()"` prevents the click from bubbling to the parent `<a>` tag. This is needed because clicking the badge should navigate to search, not to the article.

**2. Tag.astro -- Optional link to search:**

Add an optional `href` prop to the Tag component. When provided, render an `<a>` instead of a `<span>`. This keeps backward compatibility (tags without href remain spans).

```typescript
interface Props {
  label: string;
  variant?: "default" | "active" | "badge";
  href?: string;
  class?: string;
}
```

When `href` is provided, render `<a href={href} class={...}>` with the same styling plus `hover:text-teal-bright hover:border-teal/40 transition-colors`. When no href, render `<span>` as before.

**3. ArticleCard.astro -- Tags link to search:**

Update the tags rendering in ArticleCard to pass `href` to the Tag component:

```astro
{article.data.tags.map((tag) => (
  <Tag label={tag} href={`/${lang}/search?tags=${encodeURIComponent(tag)}`} />
))}
```

Add `onclick="event.stopPropagation()"` to the tag links to prevent navigation to the article when clicking a tag. Since Tag.astro renders an `<a>`, pass an `onclick` prop or handle it in the Tag component. Simplest approach: add the onclick directly in the `<a>` element inside Tag.astro when href is provided.

**4. ArticleLayout.astro -- Tags in sidebar link to search:**

In the ArticleLayout sidebar where tags are rendered, pass `href` to the Tag component:

```astro
{article.data.tags.map((tag) => (
  <Tag label={tag} href={`/${lang}/search?tags=${encodeURIComponent(tag)}`} />
))}
```

These tags are NOT inside a parent `<a>` so no stopPropagation needed.

**5. Verify existing category filter on home page is not broken:**

The CategoryFilter on the home page uses `<button data-filter="...">` which is a different mechanism (client-side show/hide). This should not be affected by the search page changes. Verify by checking the home page still filters correctly.
  </action>
  <verify>
- `npm run build` succeeds
- `npm run lint` passes
- Check built HTML: `grep "search?cat=" dist/en/articles/*/index.html | head -3` should not find matches (ArticleCard is on home, not article pages directly)
- Check home page: `grep "search?cat=" dist/en/index.html` should find category badge links in article cards
- Check article page: `grep "search?tags=" dist/en/articles/en-css-container-queries/index.html` should find tag links in the sidebar
  </verify>
  <done>Category badges on ArticleCard link to search with ?cat= param. Tags on ArticleCard and ArticleLayout link to search with ?tags= param. Tag component supports optional href prop for linkable tags. Home page category filter still works.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of complete search experience</name>
  <what-built>
Complete search page with:
- Full-text search via Pagefind custom JS API
- Category and tag sidebar filters with counts
- Grid and list view toggle
- Active filter chips with remove
- Mobile responsive drawer for filters
- URL state sync (q, cat, tags params)
- Pre-filter links from category badges and tags on other pages
- Highlighted search terms in results
- Server-rendered initial state showing all articles
  </what-built>
  <how-to-verify>
1. Run `npm run build && npm run preview` to start the local server with Pagefind index

2. **Initial state (browse all):**
   - Visit http://localhost:4321/en/search
   - Verify: Search field is empty, all articles displayed in grid view
   - Verify: Sidebar shows categories and tags with correct counts
   - Verify: No filter chips visible

3. **Full-text search:**
   - Type "CSS" in the search field
   - Verify: Results update after brief debounce
   - Verify: Matching articles appear with highlighted terms in excerpts
   - Verify: Result count updates
   - Clear the search field -- all articles reappear

4. **Category filtering:**
   - Click a category in the sidebar (e.g., "css")
   - Verify: Only articles in that category appear
   - Verify: A filter chip appears above results showing the category
   - Verify: URL updates to include ?cat=css
   - Click the x on the chip -- filter is removed

5. **Tag filtering:**
   - Click a tag in the sidebar
   - Verify: Articles with that tag appear
   - Click a second tag
   - Verify: Articles with EITHER tag appear (OR logic)
   - Verify: Two tag chips appear
   - Remove one chip -- only one tag filters

6. **Combined search + filters:**
   - Type a query AND select a category
   - Verify: Results are filtered by both
   - Verify: URL has both q= and cat= params

7. **Grid/list toggle:**
   - Click the list view icon
   - Verify: Results switch to horizontal list layout
   - Click grid icon -- back to grid

8. **Mobile responsive:**
   - Resize browser to < 1024px width
   - Verify: Sidebar disappears, "Filters" button appears
   - Verify: Grid/list toggle is hidden, results in list mode
   - Click "Filters" button -- drawer slides in from left
   - Select a filter -- drawer behavior works
   - Close drawer via backdrop or X button

9. **URL sharing / back-forward:**
   - Navigate to http://localhost:4321/en/search?q=astro&cat=css
   - Verify: Page loads with "astro" in search field and css category active
   - Use browser back button -- previous state restored

10. **Pre-filter from other pages:**
    - Go to http://localhost:4321/en/ (home page)
    - Click a category badge on an article card
    - Verify: Navigates to search page with that category pre-applied
    - Go back, click a tag on an article card
    - Verify: Navigates to search page with that tag pre-applied

11. **French version:**
    - Visit http://localhost:4321/fr/search
    - Verify: French translations (Recherche, Filtres, etc.)
    - Verify: Only French articles appear
    - Search works correctly with French content

12. **Empty results:**
    - Type a nonsense query like "xyzabc123"
    - Verify: "No results for xyzabc123" message appears
  </how-to-verify>
  <resume-signal>Type "approved" if the search experience works correctly, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
1. Category badges across the site link to search with ?cat= pre-applied
2. Tags across the site link to search with ?tags= pre-applied
3. Tag component supports optional href prop without breaking existing usage
4. Full search experience verified by human tester across all scenarios
5. `npm run build` and `npm run lint` pass
</verification>

<success_criteria>
- SRCH-05: Clicking a category or tag from any page navigates to search with pre-applied filters
- Tag component is backward compatible (no href = span, href = anchor)
- Category badge clicks don't accidentally navigate to the article
- Full end-to-end search experience verified visually by human
- All 4 phase success criteria met (search, filters+chips, grid/list, pre-filter)
</success_criteria>

<output>
After completion, create `.planning/phases/04-search-page/04-03-SUMMARY.md`
</output>
