---
phase: 06-seo-polish-deployment
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/layouts/BaseLayout.astro
  - src/layouts/ArticleLayout.astro
  - src/components/article/TableOfContents.astro
  - src/components/article/ShareButtons.astro
  - src/components/article/CategoryFilter.astro
  - src/components/ui/ReadingProgress.astro
  - src/pages/en/search.astro
  - src/pages/fr/search.astro
autonomous: true

must_haves:
  truths:
    - "User experiences smooth fade transitions when navigating between pages"
    - "Scroll reveal animations re-initialize after every client-side navigation"
    - "TOC scroll spy, reading progress bar, copy link, and code block headers work after client-side navigation"
    - "Category filter on home page re-initializes after navigating back"
    - "Search page initializes correctly after client-side navigation"
    - "No duplicate event listeners accumulate across navigations"
  artifacts:
    - path: "src/layouts/BaseLayout.astro"
      provides: "ClientRouter import and astro:page-load migration for initScrollReveal"
      contains: "ClientRouter"
    - path: "src/layouts/ArticleLayout.astro"
      provides: "astro:page-load migration for 4 scripts"
      contains: "astro:page-load"
    - path: "src/components/article/TableOfContents.astro"
      provides: "astro:page-load migration for initScrollSpy"
      contains: "astro:page-load"
    - path: "src/components/article/ShareButtons.astro"
      provides: "astro:page-load migration for initCopyLink"
      contains: "astro:page-load"
    - path: "src/components/article/CategoryFilter.astro"
      provides: "astro:page-load migration for initCategoryFilter"
      contains: "astro:page-load"
    - path: "src/components/ui/ReadingProgress.astro"
      provides: "astro:page-load migration for initReadingProgress"
      contains: "astro:page-load"
    - path: "src/pages/en/search.astro"
      provides: "astro:page-load migration for initSearch"
      contains: "astro:page-load"
    - path: "src/pages/fr/search.astro"
      provides: "astro:page-load migration for initSearch"
      contains: "astro:page-load"
  key_links:
    - from: "src/layouts/BaseLayout.astro"
      to: "astro:transitions"
      via: "ClientRouter import in head"
      pattern: "import.*ClientRouter.*from.*astro:transitions"
    - from: "all script blocks"
      to: "astro:page-load event"
      via: "addEventListener pattern replacement"
      pattern: 'document\.addEventListener\("astro:page-load"'
---

<objective>
Add View Transitions via ClientRouter and migrate all 11 scripts from the `direct call + astro:after-swap` pattern to `astro:page-load`.

Purpose: ClientRouter provides smooth page transitions (LAYO-04 requirement). All existing scripts must be migrated to work correctly with SPA-style navigation. This is a cross-cutting change that touches every file with inline scripts.
Output: ClientRouter active in BaseLayout, all 11 scripts migrated, smooth transitions working.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-seo-polish-deployment/06-RESEARCH.md
@.planning/phases/06-seo-polish-deployment/06-01-SUMMARY.md
@src/layouts/BaseLayout.astro
@src/layouts/ArticleLayout.astro
@src/components/article/TableOfContents.astro
@src/components/article/ShareButtons.astro
@src/components/article/CategoryFilter.astro
@src/components/ui/ReadingProgress.astro
@src/pages/en/search.astro
@src/pages/fr/search.astro
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ClientRouter to BaseLayout and migrate BaseLayout + ArticleLayout scripts</name>
  <files>
    src/layouts/BaseLayout.astro
    src/layouts/ArticleLayout.astro
  </files>
  <action>
**1. Add ClientRouter to `src/layouts/BaseLayout.astro`:**

Add import at top of frontmatter: `import { ClientRouter } from "astro:transitions";`

Add `<ClientRouter />` inside `<head>`, after the sitemap link (last element in head). This enables View Transitions with default fade animation across all pages.

**2. Migrate `initScrollReveal` in BaseLayout.astro:**

Replace the current script pattern:
```javascript
// BEFORE:
function initScrollReveal() { /* ... */ }
initScrollReveal();
document.addEventListener("astro:after-swap", initScrollReveal);

// AFTER:
document.addEventListener("astro:page-load", () => {
  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          entry.target.classList.add("in-view");
          observer.unobserve(entry.target);
        }
      });
    },
    { threshold: 0.1, rootMargin: "0px 0px -50px 0px" },
  );
  document
    .querySelectorAll(".fade-up:not(.in-view), .section-title:not(.in-view)")
    .forEach((el) => observer.observe(el));
});
```

Key change: No direct call, no `astro:after-swap` listener. The `astro:page-load` event fires on BOTH initial load and every client-side navigation.

**3. Migrate all 4 scripts in `src/layouts/ArticleLayout.astro`:**

Apply the same pattern to each of the 4 scripts:

a) `initHeadingAnchorCopy` -- wrap body in `document.addEventListener("astro:page-load", () => { ... });`, remove the direct call and the `astro:after-swap` listener.

b) `initCodeBlockHeaders` -- same migration pattern.

c) `initMobileCodeCopy` -- same migration pattern.

d) `initMobileToc` -- same migration pattern.

For each script, the transformation is:
```javascript
// BEFORE:
function initX() { /* ... */ }
initX();
document.addEventListener("astro:after-swap", initX);

// AFTER:
document.addEventListener("astro:page-load", () => {
  // ... body of initX directly here (no function wrapper needed) ...
});
```

Important: For `initMobileCodeCopy`, the `window.matchMedia` check inside should remain -- it's a runtime guard, not an initialization issue.

Important: For `initMobileToc`, the null guards (`if (!btn || !ov || !pn) return;`) should remain inside the page-load handler since these elements only exist on article pages.

Important: Since ArticleLayout has 4 separate `<script>` blocks, you can keep them as 4 separate `<script>` blocks, each with their own `astro:page-load` listener. Alternatively, consolidate them into one `<script>` block with a single `astro:page-load` listener that calls all init functions. The consolidated approach is cleaner -- use it. Define the 4 init functions inside the single event handler callback:

```javascript
document.addEventListener("astro:page-load", () => {
  // Heading anchor copy
  (function() { /* ... */ })();

  // Code block headers
  (function() { /* ... */ })();

  // Mobile code copy
  (function() { /* ... */ })();

  // Mobile TOC
  (function() { /* ... */ })();
});
```
  </action>
  <verify>
Run `npm run build` -- build succeeds. Run `npm run lint` -- no lint errors. Grep for `astro:after-swap` in BaseLayout.astro and ArticleLayout.astro -- should return zero matches. Grep for `astro:page-load` -- should return matches in both files. Grep for `ClientRouter` in BaseLayout.astro -- should match.
  </verify>
  <done>
ClientRouter is active in BaseLayout head. BaseLayout's scroll reveal script uses `astro:page-load`. ArticleLayout's 4 scripts (heading anchor copy, code block headers, mobile code copy, mobile TOC) all use `astro:page-load`. No `astro:after-swap` references remain in either layout file.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate remaining 5 component/page scripts to astro:page-load</name>
  <files>
    src/components/article/TableOfContents.astro
    src/components/article/ShareButtons.astro
    src/components/article/CategoryFilter.astro
    src/components/ui/ReadingProgress.astro
    src/pages/en/search.astro
    src/pages/fr/search.astro
  </files>
  <action>
Apply the same migration pattern to each of these 5 scripts (6 files, since search exists in both locales):

**1. `src/components/article/TableOfContents.astro` -- `initScrollSpy`:**
Replace `initScrollSpy(); document.addEventListener("astro:after-swap", initScrollSpy);` with wrapping the entire function body in `document.addEventListener("astro:page-load", () => { ... });`.

**2. `src/components/article/ShareButtons.astro` -- `initCopyLink`:**
Same pattern. Wrap the button querySelectorAll and event listener setup in `astro:page-load`.

**3. `src/components/article/CategoryFilter.astro` -- `initCategoryFilter`:**
Same pattern. Wrap the filter button and card querySelectorAll in `astro:page-load`.

**4. `src/components/ui/ReadingProgress.astro` -- `initReadingProgress`:**
Same pattern. Wrap the progress bar scroll handler setup in `astro:page-load`.

Important for ReadingProgress: The scroll event listener added in `initReadingProgress` will accumulate across navigations if not cleaned up. However, since the handler checks for the existence of `#reading-progress` and `article` elements (which only exist on article pages), stale listeners on non-article pages will early-return harmlessly. This is acceptable for a personal blog. If needed later, use `astro:before-swap` to remove the listener, but skip this optimization for now.

**5. `src/pages/en/search.astro` and `src/pages/fr/search.astro` -- `initSearch`:**
Same pattern. These files have large `initSearch` functions. Find the two lines at the bottom:
```javascript
initSearch();
document.addEventListener("astro:after-swap", initSearch);
```
Replace with wrapping the `initSearch` function body in `astro:page-load`. Since the search script is very large, the simplest approach is:
```javascript
document.addEventListener("astro:page-load", () => {
  // Keep initSearch as a named function for readability
  function initSearch() { /* existing body unchanged */ }
  initSearch();
});
```

**After all migrations, verify no `astro:after-swap` references remain anywhere in `src/`.**
  </action>
  <verify>
Run `npm run build` -- build succeeds. Run `npm run lint` -- no lint errors. Run `grep -r "astro:after-swap" src/` -- should return zero results. Run `grep -r "astro:page-load" src/` -- should return 8 matches (BaseLayout, ArticleLayout, TableOfContents, ShareButtons, CategoryFilter, ReadingProgress, en/search, fr/search).
  </verify>
  <done>
All 11 scripts across the codebase have been migrated from `direct call + astro:after-swap` to `astro:page-load`. Zero references to `astro:after-swap` remain in `src/`. View Transitions work with default fade animation and all interactive features re-initialize correctly after client-side navigation.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `npm run lint` passes
3. Zero instances of `astro:after-swap` in `src/` directory
4. `ClientRouter` imported and rendered in BaseLayout `<head>`
5. All 11 scripts use `astro:page-load` pattern
6. `npm run test` passes (no unit test regressions)
</verification>

<success_criteria>
- ClientRouter is active in BaseLayout, enabling View Transitions with default fade
- All 11 scripts migrated to `astro:page-load` event pattern
- Zero `astro:after-swap` references remain in the codebase
- Build, lint, and tests pass cleanly
- Scripts correctly re-initialize after client-side navigation (scroll reveal, TOC spy, reading progress, copy link, code headers, category filter, search)
</success_criteria>

<output>
After completion, create `.planning/phases/06-seo-polish-deployment/06-02-SUMMARY.md`
</output>
