# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Commands

### Development
- `npm run dev` — Start dev server (runs `wrangler types && astro dev`)
- `npm run build` — Full build: wrangler types → astro check → astro build → pagefind indexing
- `npm run preview` — Build + preview with Wrangler Pages locally

### Testing
- `npm run test` — Run unit tests once (vitest)
- `npm run test:watch` — Tests in watch mode
- `npm run test:coverage` — Tests with v8 coverage
- `npm run test:mutation` — Mutation testing (stryker, local only)
- `npm run test:e2e` — E2E tests (playwright, chromium)
- Run a single test: `npx vitest run src/utils/dates.test.ts`

### Quality
- `npm run lint` — ESLint
- `npm run lint:content` — Markdownlint on `src/content/**/*.{md,mdx}`
- `npm run format` / `npm run format:check` — Prettier
- `npm run knip` — Dead code detection
- `npm run typecheck` — Full type check (astro sync + astro check + tsc --noEmit)

### Quality Report Script
`./scripts/quality-report.sh` — Compact report optimized for LLM consumption (minimal tokens):
```
-t  tests only (no coverage)    -c  tests + coverage (-c implies -t)
-k  knip (dead code)            -m  mutation testing (stryker)
-a  all (-t -c -k -m)           -v  verbose (full logs)
-o FILE  write to file (ANSI stripped)
```

## Architecture

**Astro 5 static site** deployed on Cloudflare Pages. Bilingual (EN default + FR), all routes locale-prefixed (`/en/...`, `/fr/...`).

### Content Layer
- Config: `src/content.config.ts` (NOT `src/content/config.ts`)
- MDX articles in `src/content/articles/` loaded via `glob()` loader
- Schema enforces `pillarTags` enum: `"IA"`, `"Ingénierie"`, `"UX"` (min 1)
- `draft: true` articles are filtered out by `src/lib/articles.ts`
- Articles support `series` (id, episode, total) and `translationSlug` for cross-locale linking

### Routing
- `src/pages/index.astro` — redirect to default locale
- `src/pages/{en,fr}/index.astro` — home pages
- `src/pages/{en,fr}/articles/[id].astro` — dynamic article pages (use `entry.id` NOT `entry.slug`)
- `src/pages/{en,fr}/search.astro` — Pagefind client-side search
- `src/pages/{en,fr}/about.astro`

### Key Modules
- `src/lib/articles.ts` — Article queries (by locale, featured, related by score, categories)
- `src/i18n/utils.ts` — `getLangFromUrl()`, `useTranslations()` returning `t(key)` function
- `src/i18n/ui.ts` — UI translation strings (en/fr)
- `src/utils/dates.ts` — `formatDate(date, lang)` using `Intl.DateTimeFormat`

### Layouts & Components
- `BaseLayout.astro` → Header, Footer, scroll reveal
- `ArticleLayout.astro` → TOC, reading progress bar, share buttons
- Components organized: `layout/`, `article/`, `ui/`

### Styling
- **Tailwind CSS v4** via `@tailwindcss/vite` (NOT `@astrojs/tailwind`)
- Global styles: `src/styles/global.css` with `@theme` block defining color tokens
- Dark theme: void/canvas/surface backgrounds, teal accent `#0D9488`
- Fonts: Albert Sans (body), Fira Code (code)
- Use `@reference "../styles/global.css"` in `<style>` blocks for `@apply` with Tailwind v4

## Astro 5 Gotchas
- `import { render } from 'astro:content'` NOT `entry.render()`
- `import { z } from 'astro/zod'` NOT `from 'zod'`
- `output: 'static'` only (no `hybrid` in v5)
- `getViteConfig()` from `astro/config` needs `as any` cast for test property in vitest config
- `worker-configuration.d.ts` is auto-generated by `wrangler types` — excluded from lint/format
- Path alias: `@/*` maps to `src/*`

## CI/CD
- **PR**: Quality Gate (`quality.yml`) — prettier, eslint, markdownlint, astro check, knip, vitest+coverage, npm audit, playwright E2E, Lighthouse CI (0.9 min scores)
- **Push to main**: Deploy (`deploy.yml`) — build + Cloudflare Pages deploy via wrangler
- **Pre-commit** (lefthook): prettier, eslint, markdownlint on staged files
