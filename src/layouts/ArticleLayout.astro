---
import BaseLayout from "@/layouts/BaseLayout.astro";
import ArticleHeader from "@/components/article/ArticleHeader.astro";
import TableOfContents from "@/components/article/TableOfContents.astro";
import ShareButtons from "@/components/article/ShareButtons.astro";
import RelatedArticles from "@/components/article/RelatedArticles.astro";
import ReadingProgress from "@/components/ui/ReadingProgress.astro";
import Tag from "@/components/ui/Tag.astro";
import { getRelatedArticles, type Article } from "@/lib/articles";
import { getLangFromUrl, useTranslations } from "@/i18n/utils";

interface Props {
  article: Article;
  headings: { depth: number; slug: string; text: string }[];
}

const { article, headings } = Astro.props;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Get related articles
const relatedArticles = await getRelatedArticles(article);

// Compute article URL for sharing
const articleUrl = new URL(Astro.url.pathname, Astro.site).href;

// Build translation map for LangSwitch
const otherLang = lang === "en" ? "fr" : "en";
const translationMap: Record<string, string> = {
  [lang]: `/${lang}/articles/${article.id}`,
};
if (article.data.translationSlug) {
  translationMap[otherLang] =
    `/${otherLang}/articles/${article.data.translationSlug}`;
}
---

<BaseLayout
  title={article.data.title}
  description={article.data.description}
  translationMap={translationMap}
>
  <ReadingProgress />
  <div class="max-w-6xl mx-auto px-6 lg:px-8 py-12 md:py-16">
    <div class="lg:grid lg:grid-cols-[1fr_240px] lg:gap-12">
      <article>
        <ArticleHeader article={article} />
        <div class="prose max-w-none" id="article-content">
          <slot />
        </div>
        <RelatedArticles articles={relatedArticles} />
      </article>
      <!-- Mobile TOC: floating button + slide-in panel -->
      <button
        id="toc-mobile-btn"
        class="lg:hidden fixed bottom-6 right-6 z-50 w-12 h-12 rounded-full bg-teal text-canvas flex items-center justify-center shadow-lg shadow-teal-glow hover:bg-teal-hover transition-colors"
        aria-label={t("article.toc")}
      >
        <svg
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="3" y1="6" x2="21" y2="6"></line><line
            x1="3"
            y1="12"
            x2="15"
            y2="12"></line><line x1="3" y1="18" x2="9" y2="18"></line>
        </svg>
      </button>

      <div
        id="toc-mobile-overlay"
        class="lg:hidden fixed inset-0 z-50 pointer-events-none opacity-0 transition-opacity duration-300"
      >
        <div
          class="absolute inset-0 bg-canvas/80 backdrop-blur-sm"
          data-toc-backdrop
        >
        </div>
        <div
          id="toc-mobile-panel"
          class="absolute inset-y-0 right-0 w-full max-w-sm bg-canvas border-l border-border translate-x-full transition-transform duration-300 ease-out flex flex-col"
        >
          <div
            class="flex items-center justify-between px-6 py-4 border-b border-border"
          >
            <h3
              class="text-xs font-semibold uppercase tracking-widest text-text-muted"
            >
              {t("article.toc")}
            </h3>
            <button
              data-toc-close
              class="text-text-muted hover:text-text-primary p-1"
              aria-label="Fermer"
            >
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="18" y1="6" x2="6" y2="18"></line><line
                  x1="6"
                  y1="6"
                  x2="18"
                  y2="18"></line>
              </svg>
            </button>
          </div>
          <nav class="flex-1 overflow-y-auto px-6 py-6">
            <ul class="space-y-1">
              {
                headings
                  .filter((h) => h.depth === 2 || h.depth === 3)
                  .map((heading) => (
                    <li>
                      <a
                        href={`#${heading.slug}`}
                        data-toc-mobile-link
                        class:list={[
                          "toc-link block text-base text-text-muted hover:text-text-primary py-2.5 border-l-2 border-border transition-colors",
                          heading.depth === 2 ? "pl-4" : "pl-7",
                        ]}
                      >
                        {heading.text}
                      </a>
                    </li>
                  ))
              }
            </ul>
          </nav>
        </div>
      </div>

      <aside class="hidden lg:block">
        <div class="sticky top-24">
          <TableOfContents headings={headings} />
          <div class="mt-8">
            <h3
              class="text-xs font-semibold uppercase tracking-widest text-text-muted mb-4"
            >
              {t("article.tags")}
            </h3>
            <div class="flex flex-wrap gap-2">
              {article.data.tags.map((tag) => <Tag label={tag} />)}
            </div>
          </div>
          <div class="mt-8">
            <ShareButtons url={articleUrl} title={article.data.title} />
          </div>
        </div>
      </aside>
    </div>
  </div>
</BaseLayout>

<script>
  function initHeadingAnchorCopy() {
    document.querySelectorAll(".heading-anchor").forEach((anchor: Element) => {
      anchor.addEventListener("click", async (e: Event) => {
        e.preventDefault();
        const hash = anchor.getAttribute("href");
        if (!hash) return;

        const url = window.location.origin + window.location.pathname + hash;

        try {
          await navigator.clipboard.writeText(url);
          // Update URL hash for navigation
          window.history.pushState(null, "", hash);
          // Visual feedback
          anchor.classList.add("text-teal-bright");
          setTimeout(() => anchor.classList.remove("text-teal-bright"), 1500);
        } catch (error) {
          console.error("Failed to copy URL:", error);
        }
      });
    });
  }

  initHeadingAnchorCopy();
  document.addEventListener("astro:after-swap", initHeadingAnchorCopy);

  function initCodeBlockHeaders() {
    document.querySelectorAll(".expressive-code .frame").forEach((frame) => {
      const header = frame.querySelector(".header");
      const pre = frame.querySelector("pre[data-language]");
      if (!header || !pre) return;
      if (header.querySelector(".ec-lang-label")) return;

      const lang = pre.getAttribute("data-language") || "";

      // Language label always appended at end (right side via margin-left:auto)
      const label = document.createElement("span");
      label.className = "ec-lang-label";
      label.textContent = lang;
      header.appendChild(label);
    });
  }

  initCodeBlockHeaders();
  document.addEventListener("astro:after-swap", initCodeBlockHeaders);

  function initMobileCodeCopy() {
    const isMobile = window.matchMedia("(max-width: 1023px)").matches;
    if (!isMobile) return;

    document.querySelectorAll(".expressive-code .frame").forEach((frame) => {
      const pre = frame.querySelector("pre");
      if (!pre || pre.hasAttribute("data-mobile-copy")) return;
      pre.setAttribute("data-mobile-copy", "");

      pre.addEventListener("click", async () => {
        const code = pre.querySelector("code");
        if (!code) return;
        const text = code.innerText || code.textContent || "";

        try {
          await navigator.clipboard.writeText(text);
        } catch {
          return;
        }

        // Show feedback overlay
        const existing = pre.querySelector(".mobile-copy-feedback");
        if (existing) existing.remove();

        const feedback = document.createElement("div");
        feedback.className = "mobile-copy-feedback";
        feedback.textContent =
          document.documentElement.lang === "fr" ? "CopiÃ© !" : "Copied!";
        pre.appendChild(feedback);

        requestAnimationFrame(() => feedback.classList.add("show"));
        setTimeout(() => {
          feedback.classList.remove("show");
          setTimeout(() => feedback.remove(), 300);
        }, 1200);
      });
    });
  }

  initMobileCodeCopy();
  document.addEventListener("astro:after-swap", initMobileCodeCopy);

  function initMobileToc() {
    const btn = document.getElementById("toc-mobile-btn");
    const ov = document.getElementById("toc-mobile-overlay");
    const pn = document.getElementById("toc-mobile-panel");
    if (!btn || !ov || !pn) return;
    const overlay = ov as HTMLElement;
    const panel = pn as HTMLElement;

    function open() {
      overlay.classList.remove("pointer-events-none", "opacity-0");
      overlay.classList.add("pointer-events-auto", "opacity-100");
      panel.classList.remove("translate-x-full");
      panel.classList.add("translate-x-0");
      document.body.style.overflow = "hidden";
    }

    function close() {
      overlay.classList.add("pointer-events-none", "opacity-0");
      overlay.classList.remove("pointer-events-auto", "opacity-100");
      panel.classList.add("translate-x-full");
      panel.classList.remove("translate-x-0");
      document.body.style.overflow = "";
    }

    btn.addEventListener("click", open);
    overlay
      .querySelector("[data-toc-backdrop]")
      ?.addEventListener("click", close);
    overlay.querySelector("[data-toc-close]")?.addEventListener("click", close);
    overlay.querySelectorAll("[data-toc-mobile-link]").forEach((link) => {
      link.addEventListener("click", () => {
        close();
      });
    });
  }

  initMobileToc();
  document.addEventListener("astro:after-swap", initMobileToc);
</script>
