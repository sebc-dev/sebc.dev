---
import BaseLayout from "@/layouts/BaseLayout.astro";
import ArticleCard from "@/components/article/ArticleCard.astro";
import { getArticlesByLocale, getCategories, getTags } from "@/lib/articles";
import { getLangFromUrl, useTranslations } from "@/i18n/utils";

export function getStaticPaths() {
  return [{ params: { lang: "en" } }, { params: { lang: "fr" } }];
}
import { computeCategoryCounts, computeTagCounts } from "@/lib/filterCounts";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const otherLang = lang === "en" ? "fr" : "en";
const currentPath = Astro.url.pathname;
const otherPath =
  currentPath === `/${lang}`
    ? `/${otherLang}`
    : currentPath.replace(`/${lang}/`, `/${otherLang}/`);
const translationMap = { [lang]: currentPath, [otherLang]: otherPath };

const allArticles = await getArticlesByLocale(lang);
const categories = await getCategories(lang);
const tags = await getTags(lang);

const categoryCounts = computeCategoryCounts(allArticles, categories);
const tagCounts = computeTagCounts(allArticles, tags);

// Reading time and date ranges for filters
const readingTimes = allArticles.map((a) => a.data.readingTime);
const minReadingTime = Math.min(...readingTimes);
const maxReadingTime = Math.max(...readingTimes);
---

<BaseLayout
  title={t("search.title")}
  description={t("search.description")}
  translationMap={translationMap}
>
  <section
    data-pagefind-ignore
    class="max-w-6xl mx-auto px-6 lg:px-8 py-12 md:py-16"
  >
    <!-- Page header -->
    <h1 class="text-3xl md:text-5xl font-bold mb-8">{t("search.title")}</h1>

    <!-- Search input -->
    <div class="mb-4">
      <input
        id="search-input"
        type="search"
        placeholder={t("search.placeholder")}
        class="bg-surface border border-border rounded-xs px-4 py-3 text-text-primary placeholder:text-text-muted focus:outline-none focus:border-teal/50 w-full font-body"
        autocomplete="off"
      />
    </div>

    <!-- Active filter chips area -->
    <div
      id="filter-chips"
      class="flex flex-wrap items-center gap-2 mb-6 min-h-[0px]"
    >
    </div>

    <!-- Main content area -->
    <div class="lg:grid lg:grid-cols-[240px_1fr] lg:gap-8">
      <!-- Left sidebar (desktop) -->
      <aside id="filter-sidebar" class="hidden lg:block">
        <div class="sticky top-24">
          <!-- Categories -->
          <div class="mb-8">
            <h3
              class="text-xs font-semibold uppercase tracking-widest text-text-muted mb-4"
            >
              {t("search.categories")}
            </h3>
            <div class="flex flex-col gap-1.5">
              {
                categories.map((cat) => (
                  <button
                    data-filter-category={cat}
                    data-count={categoryCounts[cat]}
                    class="text-sm font-medium px-3.5 py-1.5 rounded-xs border border-border text-text-muted whitespace-nowrap transition-all hover:border-teal/40 hover:text-teal-bright text-left"
                  >
                    {cat}
                  </button>
                ))
              }
            </div>
          </div>
          <!-- Tags -->
          <div>
            <h3
              class="text-xs font-semibold uppercase tracking-widest text-text-muted mb-4"
            >
              {t("search.tags")}
            </h3>
            <div class="flex flex-wrap gap-1.5">
              {
                tags.map((tag) => (
                  <button
                    data-filter-tag={tag}
                    data-count={tagCounts[tag]}
                    class="text-xs font-code px-2.5 py-1 rounded-xs border border-border text-text-secondary whitespace-nowrap transition-all hover:border-teal/40 hover:text-teal-bright"
                  >
                    {tag}
                  </button>
                ))
              }
            </div>
          </div>
          <!-- Date range -->
          <div class="mt-8">
            <h3
              class="text-xs font-semibold uppercase tracking-widest text-text-muted mb-4"
            >
              {t("search.dateRange")}
            </h3>
            <div class="flex flex-col gap-2">
              <label for="date-from" class="text-xs text-text-muted"
                >{t("search.dateFrom")}</label
              >
              <div class="date-picker-wrapper">
                <input
                  type="text"
                  id="date-from"
                  placeholder={lang === "fr" ? "JJ-MM-AAAA" : "YYYY-MM-DD"}
                  readonly
                  class="date-picker-input bg-surface border border-border rounded-xs px-3 py-1.5 text-sm text-text-primary focus:outline-none focus:border-teal/50 font-body w-full cursor-pointer"
                />
                <div id="cal-date-from" class="date-picker-dropdown hidden">
                </div>
              </div>
              <label for="date-to" class="text-xs text-text-muted"
                >{t("search.dateTo")}</label
              >
              <div class="date-picker-wrapper">
                <input
                  type="text"
                  id="date-to"
                  placeholder={lang === "fr" ? "JJ-MM-AAAA" : "YYYY-MM-DD"}
                  readonly
                  class="date-picker-input bg-surface border border-border rounded-xs px-3 py-1.5 text-sm text-text-primary focus:outline-none focus:border-teal/50 font-body w-full cursor-pointer"
                />
                <div id="cal-date-to" class="date-picker-dropdown hidden"></div>
              </div>
            </div>
          </div>
          <!-- Reading time -->
          <div class="mt-8">
            <h3
              class="text-xs font-semibold uppercase tracking-widest text-text-muted mb-4"
            >
              {t("search.readingTime")}
            </h3>
            <div class="flex justify-between text-xs text-text-muted mb-3">
              <span id="rt-min-label"
                >{minReadingTime} {t("search.minutes")}</span
              >
              <span id="rt-max-label"
                >{maxReadingTime} {t("search.minutes")}</span
              >
            </div>
            <div class="range-slider-container">
              <div class="range-slider-track"></div>
              <div id="rt-range-fill" class="range-slider-fill"></div>
              <input
                type="range"
                id="rt-min"
                min={minReadingTime}
                max={maxReadingTime}
                value={minReadingTime}
                class="range-slider-input"
              />
              <input
                type="range"
                id="rt-max"
                min={minReadingTime}
                max={maxReadingTime}
                value={maxReadingTime}
                class="range-slider-input"
              />
            </div>
          </div>
        </div>
      </aside>

      <!-- Mobile filter button -->
      <button
        id="filter-mobile-btn"
        class="lg:hidden flex items-center gap-2 text-sm font-medium px-3.5 py-2 rounded-xs border border-border text-text-muted hover:border-teal/40 hover:text-teal-bright transition-all mb-4"
      >
        <svg
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="4" y1="6" x2="20" y2="6"></line>
          <line x1="8" y1="12" x2="20" y2="12"></line>
          <line x1="12" y1="18" x2="20" y2="18"></line>
        </svg>
        {t("search.filters")}
      </button>

      <!-- Mobile filter drawer -->
      <div
        id="filter-drawer-overlay"
        class="lg:hidden fixed inset-0 z-50 pointer-events-none opacity-0 transition-opacity duration-300"
      >
        <div
          class="absolute inset-0 bg-canvas/80 backdrop-blur-sm"
          data-filter-backdrop
        >
        </div>
        <div
          id="filter-drawer-panel"
          class="absolute inset-y-0 left-0 w-full max-w-sm bg-canvas border-r border-border -translate-x-full transition-transform duration-300 ease-out flex flex-col"
        >
          <div
            class="flex items-center justify-between px-6 py-4 border-b border-border"
          >
            <h3
              class="text-xs font-semibold uppercase tracking-widest text-text-muted"
            >
              {t("search.filters")}
            </h3>
            <button
              data-filter-close
              class="text-text-muted hover:text-text-primary p-1"
              aria-label="Close"
            >
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
          <nav class="flex-1 overflow-y-auto px-6 py-6">
            <!-- Mobile Categories -->
            <div class="mb-8">
              <h3
                class="text-xs font-semibold uppercase tracking-widest text-text-muted mb-4"
              >
                {t("search.categories")}
              </h3>
              <div class="flex flex-col gap-1.5">
                {
                  categories.map((cat) => (
                    <button
                      data-filter-category-mobile={cat}
                      data-count={categoryCounts[cat]}
                      class="text-sm font-medium px-3.5 py-1.5 rounded-xs border border-border text-text-muted whitespace-nowrap transition-all hover:border-teal/40 hover:text-teal-bright text-left"
                    >
                      {cat}{" "}
                      <span class="text-text-muted opacity-60">
                        ({categoryCounts[cat]})
                      </span>
                    </button>
                  ))
                }
              </div>
            </div>
            <!-- Mobile Tags -->
            <div>
              <h3
                class="text-xs font-semibold uppercase tracking-widest text-text-muted mb-4"
              >
                {t("search.tags")}
              </h3>
              <div class="flex flex-wrap gap-1.5">
                {
                  tags.map((tag) => (
                    <button
                      data-filter-tag-mobile={tag}
                      data-count={tagCounts[tag]}
                      class="text-xs font-code px-2.5 py-1 rounded-xs border border-border text-text-secondary whitespace-nowrap transition-all hover:border-teal/40 hover:text-teal-bright"
                    >
                      {tag}
                    </button>
                  ))
                }
              </div>
            </div>
            <!-- Mobile Date range -->
            <div class="mt-8">
              <h3
                class="text-xs font-semibold uppercase tracking-widest text-text-muted mb-4"
              >
                {t("search.dateRange")}
              </h3>
              <div class="flex flex-col gap-2">
                <label for="date-from-mobile" class="text-xs text-text-muted"
                  >{t("search.dateFrom")}</label
                >
                <div class="date-picker-wrapper">
                  <input
                    type="text"
                    id="date-from-mobile"
                    placeholder={lang === "fr" ? "JJ-MM-AAAA" : "YYYY-MM-DD"}
                    readonly
                    class="date-picker-input bg-surface border border-border rounded-xs px-3 py-1.5 text-sm text-text-primary focus:outline-none focus:border-teal/50 font-body w-full cursor-pointer"
                  />
                  <div
                    id="cal-date-from-mobile"
                    class="date-picker-dropdown hidden"
                  >
                  </div>
                </div>
                <label for="date-to-mobile" class="text-xs text-text-muted"
                  >{t("search.dateTo")}</label
                >
                <div class="date-picker-wrapper">
                  <input
                    type="text"
                    id="date-to-mobile"
                    placeholder={lang === "fr" ? "JJ-MM-AAAA" : "YYYY-MM-DD"}
                    readonly
                    class="date-picker-input bg-surface border border-border rounded-xs px-3 py-1.5 text-sm text-text-primary focus:outline-none focus:border-teal/50 font-body w-full cursor-pointer"
                  />
                  <div
                    id="cal-date-to-mobile"
                    class="date-picker-dropdown hidden"
                  >
                  </div>
                </div>
              </div>
            </div>
            <!-- Mobile Reading time -->
            <div class="mt-8">
              <h3
                class="text-xs font-semibold uppercase tracking-widest text-text-muted mb-4"
              >
                {t("search.readingTime")}
              </h3>
              <div class="flex justify-between text-xs text-text-muted mb-3">
                <span id="rt-min-label-mobile"
                  >{minReadingTime} {t("search.minutes")}</span
                >
                <span id="rt-max-label-mobile"
                  >{maxReadingTime} {t("search.minutes")}</span
                >
              </div>
              <div class="range-slider-container">
                <div class="range-slider-track"></div>
                <div id="rt-range-fill-mobile" class="range-slider-fill"></div>
                <input
                  type="range"
                  id="rt-min-mobile"
                  min={minReadingTime}
                  max={maxReadingTime}
                  value={minReadingTime}
                  class="range-slider-input"
                />
                <input
                  type="range"
                  id="rt-max-mobile"
                  min={minReadingTime}
                  max={maxReadingTime}
                  value={maxReadingTime}
                  class="range-slider-input"
                />
              </div>
            </div>
          </nav>
        </div>
      </div>

      <!-- Results area -->
      <div>
        <!-- View toggle + result count bar -->
        <div class="flex items-center justify-between mb-6">
          <p id="result-count" class="text-sm text-text-muted">
            {allArticles.length}
            {
              allArticles.length === 1
                ? t("search.resultCountSingular")
                : t("search.resultCount")
            }
          </p>
          <div
            id="view-toggle"
            class="hidden lg:flex items-center gap-1 border border-border rounded-xs p-0.5"
          >
            <button
              data-view="grid"
              class="p-1.5 rounded-xs text-teal-bright bg-teal-dim transition-colors"
              aria-label={t("search.gridView")}
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="3" width="7" height="7"></rect>
                <rect x="3" y="14" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
              </svg>
            </button>
            <button
              data-view="list"
              class="p-1.5 rounded-xs text-text-muted transition-colors hover:text-text-primary"
              aria-label={t("search.listView")}
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
              </svg>
            </button>
          </div>
        </div>

        <!-- Loading state -->
        <div id="search-loading" class="hidden">
          <div
            class="flex items-center gap-3 text-text-muted py-12 justify-center"
          >
            <div
              class="w-4 h-4 border-2 border-teal/30 border-t-teal rounded-full animate-spin"
            >
            </div>
            <span class="text-sm">{t("search.loading")}</span>
          </div>
        </div>

        <!-- No results message -->
        <div id="no-results" class="hidden">
          <p class="text-text-secondary text-center py-12"></p>
        </div>

        <!-- Server-rendered articles grid (initial state) -->
        <div
          id="initial-articles"
          class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"
        >
          {
            allArticles.map((article) => (
              <div
                data-article-date={
                  article.data.date.toISOString().split("T")[0]
                }
                data-article-reading-time={article.data.readingTime}
              >
                <ArticleCard article={article} />
              </div>
            ))
          }
        </div>

        <!-- Pagefind results container -->
        <div id="search-results" class="hidden"></div>
      </div>
    </div>
  </section>
</BaseLayout>

<script>
  function initSearch() {
    // --- DOM references ---
    const searchInput = document.getElementById(
      "search-input",
    ) as HTMLInputElement | null;
    const filterChips = document.getElementById("filter-chips");
    const initialArticles = document.getElementById("initial-articles");
    const searchResults = document.getElementById("search-results");
    const noResults = document.getElementById("no-results");
    const searchLoading = document.getElementById("search-loading");
    const resultCount = document.getElementById("result-count");
    const viewToggle = document.getElementById("view-toggle");
    const filterSidebar = document.getElementById("filter-sidebar");
    const filterMobileBtn = document.getElementById("filter-mobile-btn");
    const filterDrawerOverlay = document.getElementById(
      "filter-drawer-overlay",
    );
    const filterDrawerPanel = document.getElementById("filter-drawer-panel");

    if (
      !searchInput ||
      !filterChips ||
      !initialArticles ||
      !searchResults ||
      !noResults ||
      !resultCount
    )
      return;

    // Safe references (narrowed by guard above)
    const $initial = initialArticles;
    const $results = searchResults;
    const $noResults = noResults;
    const $count = resultCount;
    const $chips = filterChips;
    const $noResultsP = $noResults.querySelector("p");

    // --- Date & reading time DOM refs ---
    const dateFrom = document.getElementById(
      "date-from",
    ) as HTMLInputElement | null;
    const dateTo = document.getElementById(
      "date-to",
    ) as HTMLInputElement | null;
    const rtMin = document.getElementById("rt-min") as HTMLInputElement | null;
    const rtMax = document.getElementById("rt-max") as HTMLInputElement | null;
    const rtMinLabel = document.getElementById("rt-min-label");
    const rtMaxLabel = document.getElementById("rt-max-label");
    const rtRangeFill = document.getElementById("rt-range-fill");
    const dateFromMobile = document.getElementById(
      "date-from-mobile",
    ) as HTMLInputElement | null;
    const dateToMobile = document.getElementById(
      "date-to-mobile",
    ) as HTMLInputElement | null;
    const rtMinMobile = document.getElementById(
      "rt-min-mobile",
    ) as HTMLInputElement | null;
    const rtMaxMobile = document.getElementById(
      "rt-max-mobile",
    ) as HTMLInputElement | null;
    const rtMinLabelMobile = document.getElementById("rt-min-label-mobile");
    const rtMaxLabelMobile = document.getElementById("rt-max-label-mobile");
    const rtRangeFillMobile = document.getElementById("rt-range-fill-mobile");

    const rtAbsMin = rtMin ? parseInt(rtMin.min) : 1;
    const rtAbsMax = rtMax ? parseInt(rtMax.max) : 30;

    // --- State ---
    interface SearchState {
      query: string;
      category: string;
      tags: string[];
      view: "grid" | "list";
      dateFrom: string;
      dateTo: string;
      readingTimeMin: number;
      readingTimeMax: number;
    }

    let state: SearchState = {
      query: "",
      category: "",
      tags: [],
      view: "grid",
      dateFrom: "",
      dateTo: "",
      readingTimeMin: rtAbsMin,
      readingTimeMax: rtAbsMax,
    };
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    let pagefind: any = null;
    let pagefindLoading = false;
    const initialArticleCount =
      initialArticles.querySelectorAll("article").length;
    const lang = document.documentElement.lang || "en";

    // --- Responsive: force list on mobile ---
    const lgMediaQuery = window.matchMedia("(min-width: 1024px)");

    function getEffectiveView(): "grid" | "list" {
      return lgMediaQuery.matches ? state.view : "list";
    }

    // --- URL state management ---
    function readStateFromUrl(): SearchState {
      const params = new URLSearchParams(window.location.search);
      return {
        query: params.get("q") || "",
        category: params.get("cat") || "",
        tags: params.get("tags")?.split(",").filter(Boolean) || [],
        view: state.view,
        dateFrom: params.get("from") || "",
        dateTo: params.get("to") || "",
        readingTimeMin: params.get("rtMin")
          ? parseInt(params.get("rtMin") ?? "")
          : rtAbsMin,
        readingTimeMax: params.get("rtMax")
          ? parseInt(params.get("rtMax") ?? "")
          : rtAbsMax,
      };
    }

    function writeStateToUrl(s: SearchState, push = false) {
      const params = new URLSearchParams();
      if (s.query) params.set("q", s.query);
      if (s.category) params.set("cat", s.category);
      if (s.tags.length) params.set("tags", s.tags.join(","));
      if (s.dateFrom) params.set("from", s.dateFrom);
      if (s.dateTo) params.set("to", s.dateTo);
      if (s.readingTimeMin !== rtAbsMin)
        params.set("rtMin", String(s.readingTimeMin));
      if (s.readingTimeMax !== rtAbsMax)
        params.set("rtMax", String(s.readingTimeMax));
      const qs = params.toString();
      const url = `${window.location.pathname}${qs ? "?" + qs : ""}`;
      if (push) {
        window.history.pushState(null, "", url);
      } else {
        window.history.replaceState(null, "", url);
      }
    }

    // --- Pagefind initialization ---
    async function initPagefind() {
      if (pagefind) return pagefind;
      if (pagefindLoading) return null;
      pagefindLoading = true;
      try {
        const pagefindPath = "/pagefind/pagefind.js";
        pagefind = await import(/* @vite-ignore */ pagefindPath);
        await pagefind.init();
        pagefindLoading = false;
        return pagefind;
      } catch {
        console.warn("Pagefind not available (run npm run build first)");
        pagefindLoading = false;
        return null;
      }
    }

    // --- Escape HTML ---
    function escapeHtml(str: string): string {
      const div = document.createElement("div");
      div.textContent = str;
      return div.innerHTML;
    }

    // --- Highlight title ---
    function highlightTitle(title: string, excerpt: string): string {
      const markRegex = /<mark>(.*?)<\/mark>/gi;
      const markedTerms: string[] = [];
      let m;
      while ((m = markRegex.exec(excerpt)) !== null) {
        const term = m[1].toLowerCase();
        if (!markedTerms.includes(term)) markedTerms.push(term);
      }
      if (markedTerms.length === 0) return escapeHtml(title);
      let result = escapeHtml(title);
      for (const term of markedTerms) {
        const regex = new RegExp(
          `(${term.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")})`,
          "gi",
        );
        result = result.replace(regex, "<mark>$1</mark>");
      }
      return result;
    }

    // --- Format date ---
    function formatDate(dateStr: string): string {
      const date = new Date(dateStr);
      return new Intl.DateTimeFormat(lang, {
        year: "numeric",
        month: "long",
        day: "numeric",
      }).format(date);
    }

    // --- Reading time label ---
    function readingTimeLabel(): string {
      return lang === "fr" ? "min de lecture" : "min read";
    }

    // --- Check if range filters are active ---
    function hasRangeFilters(): boolean {
      return (
        state.dateFrom !== "" ||
        state.dateTo !== "" ||
        state.readingTimeMin !== rtAbsMin ||
        state.readingTimeMax !== rtAbsMax
      );
    }

    // --- Post-filter by date and reading time ---
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    function passesRangeFilters(data: any): boolean {
      const date = data.meta?.date || data.dataset?.articleDate || "";
      const rt = parseInt(
        data.meta?.readingTime || data.dataset?.articleReadingTime || "0",
      );

      if (state.dateFrom && date) {
        if (date.slice(0, 10) < state.dateFrom) return false;
      }
      if (state.dateTo && date) {
        if (date.slice(0, 10) > state.dateTo) return false;
      }
      if (rt < state.readingTimeMin || rt > state.readingTimeMax) return false;
      return true;
    }

    // --- Update range slider fill position ---
    function updateRangeSliderFill(
      minInput: HTMLInputElement | null,
      maxInput: HTMLInputElement | null,
      fill: HTMLElement | null,
      minLabel: HTMLElement | null,
      maxLabel: HTMLElement | null,
    ) {
      if (!minInput || !maxInput || !fill) return;
      const min = parseInt(minInput.min);
      const max = parseInt(minInput.max);
      const range = max - min || 1;
      const minVal = parseInt(minInput.value);
      const maxVal = parseInt(maxInput.value);
      const leftPercent = ((minVal - min) / range) * 100;
      const rightPercent = ((max - maxVal) / range) * 100;
      fill.style.left = `${leftPercent}%`;
      fill.style.right = `${rightPercent}%`;
      const minuteLabel = "min";
      if (minLabel) minLabel.textContent = `${minVal} ${minuteLabel}`;
      if (maxLabel) maxLabel.textContent = `${maxVal} ${minuteLabel}`;
    }

    // --- Sync date inputs between desktop and mobile ---
    function syncDateInputs() {
      if (dateFrom) setDateValue(dateFrom, state.dateFrom);
      if (dateTo) setDateValue(dateTo, state.dateTo);
      if (dateFromMobile) setDateValue(dateFromMobile, state.dateFrom);
      if (dateToMobile) setDateValue(dateToMobile, state.dateTo);
    }

    // --- Sync range sliders between desktop and mobile ---
    function syncRangeSliders() {
      if (rtMin) rtMin.value = String(state.readingTimeMin);
      if (rtMax) rtMax.value = String(state.readingTimeMax);
      if (rtMinMobile) rtMinMobile.value = String(state.readingTimeMin);
      if (rtMaxMobile) rtMaxMobile.value = String(state.readingTimeMax);
      updateRangeSliderFill(rtMin, rtMax, rtRangeFill, rtMinLabel, rtMaxLabel);
      updateRangeSliderFill(
        rtMinMobile,
        rtMaxMobile,
        rtRangeFillMobile,
        rtMinLabelMobile,
        rtMaxLabelMobile,
      );
    }

    // --- Render grid card ---
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    function renderGridCard(data: any): string {
      const tags = data.filters?.tag || [];
      const category = data.filters?.category?.[0] || "";
      const url = data.meta?.url || data.url;
      const image = data.meta?.image;
      const title = data.meta?.title || "";
      const description = data.meta?.description || "";
      const readingTime = data.meta?.readingTime || "";
      const date = data.meta?.date || "";

      return `<article class="group">
        <a href="${escapeHtml(url)}" class="block">
          <div class="relative overflow-hidden rounded-xs border border-border group-hover:border-teal/30 transition-colors mb-4">
            ${
              image
                ? `<img src="${escapeHtml(image)}" alt="${escapeHtml(title)}" class="w-full aspect-[16/10] object-cover opacity-75 group-hover:opacity-100 transition-opacity" loading="lazy" />`
                : `<div class="w-full aspect-[16/10] bg-surface flex items-center justify-center"><span class="text-3xl font-code text-text-muted">&gt;_</span></div>`
            }
            <div class="absolute inset-0 bg-linear-to-t from-canvas/40 to-transparent"></div>
            <span class="absolute top-3 left-3 text-xs font-code text-teal bg-canvas/80 backdrop-blur-sm px-2.5 py-1 rounded-xs border border-teal/20">${escapeHtml(category)}</span>
          </div>
          <div class="flex items-center gap-2 text-xs text-text-muted mb-2.5">
            <time class="tabular-nums">${formatDate(date)}</time>
            <span class="w-1 h-1 rounded-full bg-text-muted"></span>
            <span>${escapeHtml(readingTime)} ${readingTimeLabel()}</span>
          </div>
          <h3 class="text-lg font-semibold leading-snug mb-2 group-hover:text-teal-bright transition-colors">${data.excerpt ? highlightTitle(title, data.excerpt) : escapeHtml(title)}</h3>
          <p class="text-text-secondary text-sm leading-relaxed line-clamp-2 mb-3">${data.excerpt || escapeHtml(description)}</p>
          <div class="flex flex-wrap gap-2">
            ${tags.map((t: string) => `<span class="text-xs font-code px-2.5 py-1 rounded-xs border text-text-secondary border-border">${escapeHtml(t)}</span>`).join("")}
          </div>
        </a>
      </article>`;
    }

    // --- Render list card ---
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    function renderListCard(data: any): string {
      const tags = data.filters?.tag || [];
      const category = data.filters?.category?.[0] || "";
      const url = data.meta?.url || data.url;
      const image = data.meta?.image;
      const title = data.meta?.title || "";
      const description = data.meta?.description || "";
      const readingTime = data.meta?.readingTime || "";
      const date = data.meta?.date || "";

      return `<article class="group">
        <a href="${escapeHtml(url)}" class="flex gap-4 sm:gap-6 py-4 border-b border-border">
          <div class="hidden sm:block flex-shrink-0 w-48 relative overflow-hidden rounded-xs border border-border group-hover:border-teal/30 transition-colors">
            ${
              image
                ? `<img src="${escapeHtml(image)}" alt="${escapeHtml(title)}" class="w-full aspect-video object-cover opacity-75 group-hover:opacity-100 transition-opacity" loading="lazy" />`
                : `<div class="w-full aspect-video bg-surface flex items-center justify-center"><span class="text-xl font-code text-text-muted">&gt;_</span></div>`
            }
          </div>
          <div class="flex-1 min-w-0">
            <h3 class="text-lg font-semibold leading-snug mb-1.5 group-hover:text-teal-bright transition-colors">${data.excerpt ? highlightTitle(title, data.excerpt) : escapeHtml(title)}</h3>
            <p class="text-text-secondary text-sm leading-relaxed line-clamp-2 mb-3">${data.excerpt || escapeHtml(description)}</p>
            <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-xs text-text-muted">
              <span class="font-code text-teal px-2 py-0.5 rounded-xs border border-teal/20 bg-canvas/80">${escapeHtml(category)}</span>
              <time class="tabular-nums">${formatDate(date)}</time>
              <span>${escapeHtml(readingTime)} ${readingTimeLabel()}</span>
              ${tags.map((t: string) => `<span class="font-code text-text-secondary">${escapeHtml(t)}</span>`).join("")}
            </div>
          </div>
        </a>
      </article>`;
    }

    // --- Update result count ---
    function updateResultCount(count: number) {
      const label =
        count === 1
          ? lang === "fr"
            ? "résultat"
            : "result"
          : lang === "fr"
            ? "résultats"
            : "results";
      $count.textContent = `${count} ${label}`;
    }

    // --- Update filter button states ---
    function updateFilterButtons() {
      // Desktop sidebar
      if (filterSidebar) {
        filterSidebar
          .querySelectorAll("[data-filter-category]")
          .forEach((btn) => {
            const cat = (btn as HTMLElement).dataset.filterCategory || "";
            if (cat === state.category) {
              btn.classList.add(
                "text-teal-bright",
                "border-teal",
                "bg-teal-dim",
              );
              btn.classList.remove("text-text-muted", "border-border");
            } else {
              btn.classList.remove(
                "text-teal-bright",
                "border-teal",
                "bg-teal-dim",
              );
              btn.classList.add("text-text-muted", "border-border");
            }
          });
        filterSidebar.querySelectorAll("[data-filter-tag]").forEach((btn) => {
          const tag = (btn as HTMLElement).dataset.filterTag || "";
          if (state.tags.includes(tag)) {
            btn.classList.add(
              "text-teal-bright",
              "border-teal/20",
              "bg-teal-dim",
            );
            btn.classList.remove("text-text-secondary", "border-border");
          } else {
            btn.classList.remove(
              "text-teal-bright",
              "border-teal/20",
              "bg-teal-dim",
            );
            btn.classList.add("text-text-secondary", "border-border");
          }
        });
      }

      // Mobile drawer
      if (filterDrawerPanel) {
        filterDrawerPanel
          .querySelectorAll("[data-filter-category-mobile]")
          .forEach((btn) => {
            const cat = (btn as HTMLElement).dataset.filterCategoryMobile || "";
            if (cat === state.category) {
              btn.classList.add(
                "text-teal-bright",
                "border-teal",
                "bg-teal-dim",
              );
              btn.classList.remove("text-text-muted", "border-border");
            } else {
              btn.classList.remove(
                "text-teal-bright",
                "border-teal",
                "bg-teal-dim",
              );
              btn.classList.add("text-text-muted", "border-border");
            }
          });
        filterDrawerPanel
          .querySelectorAll("[data-filter-tag-mobile]")
          .forEach((btn) => {
            const tag = (btn as HTMLElement).dataset.filterTagMobile || "";
            if (state.tags.includes(tag)) {
              btn.classList.add(
                "text-teal-bright",
                "border-teal/20",
                "bg-teal-dim",
              );
              btn.classList.remove("text-text-secondary", "border-border");
            } else {
              btn.classList.remove(
                "text-teal-bright",
                "border-teal/20",
                "bg-teal-dim",
              );
              btn.classList.add("text-text-secondary", "border-border");
            }
          });
      }
    }

    // --- Update filter counts from Pagefind results ---
    function updateFilterCounts(
      totalFilters: Record<string, Record<string, number>>,
    ) {
      if (!totalFilters) return;

      const updateBtn = (
        btn: Element,
        filterKey: string,
        filterName: string,
      ) => {
        const count = totalFilters[filterKey]?.[filterName] ?? 0;
        (btn as HTMLElement).dataset.count = String(count);
        const countSpan = btn.querySelector("span");
        if (countSpan) countSpan.textContent = `(${count})`;
      };

      // Desktop
      if (filterSidebar) {
        filterSidebar
          .querySelectorAll("[data-filter-category]")
          .forEach((btn) => {
            updateBtn(
              btn,
              "category",
              (btn as HTMLElement).dataset.filterCategory || "",
            );
          });
        filterSidebar.querySelectorAll("[data-filter-tag]").forEach((btn) => {
          updateBtn(btn, "tag", (btn as HTMLElement).dataset.filterTag || "");
        });
      }

      // Mobile
      if (filterDrawerPanel) {
        filterDrawerPanel
          .querySelectorAll("[data-filter-category-mobile]")
          .forEach((btn) => {
            updateBtn(
              btn,
              "category",
              (btn as HTMLElement).dataset.filterCategoryMobile || "",
            );
          });
        filterDrawerPanel
          .querySelectorAll("[data-filter-tag-mobile]")
          .forEach((btn) => {
            updateBtn(
              btn,
              "tag",
              (btn as HTMLElement).dataset.filterTagMobile || "",
            );
          });
      }
    }

    // --- Render filter chips ---
    function renderFilterChips() {
      const chips: string[] = [];

      if (state.category) {
        chips.push(`<span class="inline-flex items-center gap-1.5 text-xs font-code px-2.5 py-1 rounded-xs border text-teal-bright border-teal/20 bg-teal-dim">
          ${escapeHtml(state.category)}
          <button data-remove-filter="category" class="hover:text-text-primary transition-colors" aria-label="Remove ${escapeHtml(state.category)} filter">&times;</button>
        </span>`);
      }

      for (const tag of state.tags) {
        chips.push(`<span class="inline-flex items-center gap-1.5 text-xs font-code px-2.5 py-1 rounded-xs border text-teal-bright border-teal/20 bg-teal-dim">
          ${escapeHtml(tag)}
          <button data-remove-filter="tag:${escapeHtml(tag)}" class="hover:text-text-primary transition-colors" aria-label="Remove ${escapeHtml(tag)} filter">&times;</button>
        </span>`);
      }

      if (state.dateFrom || state.dateTo) {
        const fmtFrom = formatDisplayDate(state.dateFrom);
        const fmtTo = formatDisplayDate(state.dateTo);
        const dateLabel =
          state.dateFrom && state.dateTo
            ? `${fmtFrom} → ${fmtTo}`
            : state.dateFrom
              ? `${lang === "fr" ? "Depuis" : "From"} ${fmtFrom}`
              : `${lang === "fr" ? "Jusqu'au" : "Until"} ${fmtTo}`;
        chips.push(`<span class="inline-flex items-center gap-1.5 text-xs font-code px-2.5 py-1 rounded-xs border text-teal-bright border-teal/20 bg-teal-dim">
          ${escapeHtml(dateLabel)}
          <button data-remove-filter="date" class="hover:text-text-primary transition-colors" aria-label="Remove date filter">&times;</button>
        </span>`);
      }

      if (
        state.readingTimeMin !== rtAbsMin ||
        state.readingTimeMax !== rtAbsMax
      ) {
        const rtLabel = `${state.readingTimeMin}–${state.readingTimeMax} min`;
        chips.push(`<span class="inline-flex items-center gap-1.5 text-xs font-code px-2.5 py-1 rounded-xs border text-teal-bright border-teal/20 bg-teal-dim">
          ${escapeHtml(rtLabel)}
          <button data-remove-filter="readingTime" class="hover:text-text-primary transition-colors" aria-label="Remove reading time filter">&times;</button>
        </span>`);
      }

      if (chips.length > 0) {
        const clearLabel = lang === "fr" ? "Tout effacer" : "Clear all";
        chips.push(
          `<button id="clear-all-filters" class="text-xs text-text-muted hover:text-teal-bright transition-colors ml-1">${clearLabel}</button>`,
        );
      }

      $chips.innerHTML = chips.join("");

      // Attach chip event listeners
      $chips.querySelectorAll("[data-remove-filter]").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          const val = (btn as HTMLElement).dataset.removeFilter || "";
          if (val === "category") {
            state.category = "";
          } else if (val.startsWith("tag:")) {
            const tagName = val.slice(4);
            state.tags = state.tags.filter((t) => t !== tagName);
          } else if (val === "date") {
            state.dateFrom = "";
            state.dateTo = "";
            syncDateInputs();
          } else if (val === "readingTime") {
            state.readingTimeMin = rtAbsMin;
            state.readingTimeMax = rtAbsMax;
            syncRangeSliders();
          }
          writeStateToUrl(state, true);
          updateFilterButtons();
          renderFilterChips();
          performSearch();
        });
      });

      const clearAll = $chips.querySelector("#clear-all-filters");
      if (clearAll) {
        clearAll.addEventListener("click", () => {
          state.category = "";
          state.tags = [];
          state.dateFrom = "";
          state.dateTo = "";
          state.readingTimeMin = rtAbsMin;
          state.readingTimeMax = rtAbsMax;
          syncDateInputs();
          syncRangeSliders();
          writeStateToUrl(state, true);
          updateFilterButtons();
          renderFilterChips();
          performSearch();
        });
      }
    }

    // --- View toggle ---
    function updateViewToggle() {
      if (!viewToggle) return;
      const gridBtn = viewToggle.querySelector("[data-view='grid']");
      const listBtn = viewToggle.querySelector("[data-view='list']");
      if (!gridBtn || !listBtn) return;

      if (state.view === "grid") {
        gridBtn.classList.add("text-teal-bright", "bg-teal-dim");
        gridBtn.classList.remove("text-text-muted");
        listBtn.classList.remove("text-teal-bright", "bg-teal-dim");
        listBtn.classList.add("text-text-muted");
      } else {
        listBtn.classList.add("text-teal-bright", "bg-teal-dim");
        listBtn.classList.remove("text-text-muted");
        gridBtn.classList.remove("text-teal-bright", "bg-teal-dim");
        gridBtn.classList.add("text-text-muted");
      }
    }

    // --- Perform search ---
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    let lastResults: any[] | null = null;

    async function performSearch() {
      const hasQuery = state.query.trim().length > 0;
      const hasFilters = state.category !== "" || state.tags.length > 0;
      const hasRange = hasRangeFilters();

      if (!hasQuery && !hasFilters && !hasRange) {
        // Show initial state — all articles visible
        $initial.classList.remove("hidden");
        $initial.querySelectorAll("[data-article-date]").forEach((el) => {
          (el as HTMLElement).style.display = "";
        });
        $results.classList.add("hidden");
        $noResults.classList.add("hidden");
        searchLoading?.classList.add("hidden");
        updateResultCount(initialArticleCount);
        lastResults = null;
        return;
      }

      // Range-only filtering on initial articles (no Pagefind needed)
      if (!hasQuery && !hasFilters && hasRange) {
        $results.classList.add("hidden");
        $noResults.classList.add("hidden");
        searchLoading?.classList.add("hidden");
        $initial.classList.remove("hidden");
        let visibleCount = 0;
        $initial.querySelectorAll("[data-article-date]").forEach((el) => {
          const htmlEl = el as HTMLElement;
          const passes = passesRangeFilters({
            meta: {
              date: htmlEl.dataset.articleDate,
              readingTime: htmlEl.dataset.articleReadingTime,
            },
          });
          htmlEl.style.display = passes ? "" : "none";
          if (passes) visibleCount++;
        });
        updateResultCount(visibleCount);
        if (visibleCount === 0) {
          const noResultsLabel =
            lang === "fr"
              ? "Aucun résultat pour ces filtres"
              : "No results for these filters";
          if ($noResultsP) $noResultsP.textContent = noResultsLabel;
          $noResults.classList.remove("hidden");
        }
        lastResults = null;
        return;
      }

      // Initialize Pagefind if needed
      const pf = await initPagefind();
      if (!pf) {
        // Pagefind not available (dev mode)
        if ($noResultsP)
          $noResultsP.textContent =
            "Search is available in production builds only.";
        $initial.classList.add("hidden");
        $results.classList.add("hidden");
        $noResults.classList.remove("hidden");
        searchLoading?.classList.add("hidden");
        return;
      }

      // Show loading on first search
      if (!lastResults) {
        searchLoading?.classList.remove("hidden");
      }

      // Build filter object
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      const pfFilters: Record<string, any> = {};
      if (state.category) pfFilters.category = state.category;
      if (state.tags.length) pfFilters.tag = { any: state.tags };

      const searchTerm = hasQuery ? state.query : null;
      const result = await pf.debouncedSearch(
        searchTerm,
        { filters: pfFilters },
        250,
      );

      if (result === null) return; // Superseded by newer search

      searchLoading?.classList.add("hidden");
      $initial.classList.add("hidden");

      // Load result data
      const allLoaded = await Promise.all(
        result.results
          .slice(0, 50)
          .map((r: { data: () => Promise<unknown> }) => r.data()),
      );
      // Post-filter by date and reading time
      const loaded = hasRange
        ? allLoaded.filter(passesRangeFilters)
        : allLoaded;
      lastResults = loaded;

      if (loaded.length === 0) {
        $results.classList.add("hidden");
        const noResultsLabel =
          lang === "fr" ? "Aucun résultat pour" : "No results for";
        const queryDisplay =
          state.query ||
          [state.category, ...state.tags].filter(Boolean).join(", ");
        if ($noResultsP)
          $noResultsP.innerHTML = `${noResultsLabel} <span class="font-semibold text-text-primary">"${escapeHtml(queryDisplay)}"</span>`;
        $noResults.classList.remove("hidden");
        updateResultCount(0);
      } else {
        $noResults.classList.add("hidden");
        renderResults(loaded);
        updateResultCount(loaded.length);
      }

      // Update filter counts from search results
      if (result.totalFilters) {
        updateFilterCounts(result.totalFilters);
      }
    }

    // --- Render results ---
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    function renderResults(loaded: any[]) {
      const view = getEffectiveView();
      if (view === "grid") {
        $results.className =
          "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6";
        $results.innerHTML = loaded.map((d) => renderGridCard(d)).join("");
      } else {
        $results.className = "flex flex-col";
        $results.innerHTML = loaded.map((d) => renderListCard(d)).join("");
      }
      $results.classList.remove("hidden");
    }

    // --- Mobile drawer ---
    function openDrawer() {
      if (!filterDrawerOverlay || !filterDrawerPanel) return;
      filterDrawerOverlay.classList.remove("pointer-events-none", "opacity-0");
      filterDrawerOverlay.classList.add("pointer-events-auto", "opacity-100");
      filterDrawerPanel.classList.remove("-translate-x-full");
      filterDrawerPanel.classList.add("translate-x-0");
      document.body.style.overflow = "hidden";
    }

    function closeDrawer() {
      if (!filterDrawerOverlay || !filterDrawerPanel) return;
      filterDrawerOverlay.classList.add("pointer-events-none", "opacity-0");
      filterDrawerOverlay.classList.remove(
        "pointer-events-auto",
        "opacity-100",
      );
      filterDrawerPanel.classList.add("-translate-x-full");
      filterDrawerPanel.classList.remove("translate-x-0");
      document.body.style.overflow = "";
    }

    // --- Event listeners ---

    // Search input
    searchInput.addEventListener("input", () => {
      state.query = searchInput.value;
      writeStateToUrl(state, false);
      performSearch();
    });

    // Lazy init Pagefind on focus
    searchInput.addEventListener("focus", () => initPagefind(), { once: true });

    // Category filter clicks (desktop)
    filterSidebar?.querySelectorAll("[data-filter-category]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const cat = (btn as HTMLElement).dataset.filterCategory || "";
        state.category = state.category === cat ? "" : cat;
        writeStateToUrl(state, true);
        updateFilterButtons();
        renderFilterChips();
        performSearch();
      });
    });

    // Tag filter clicks (desktop)
    filterSidebar?.querySelectorAll("[data-filter-tag]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const tag = (btn as HTMLElement).dataset.filterTag || "";
        if (state.tags.includes(tag)) {
          state.tags = state.tags.filter((t) => t !== tag);
        } else {
          state.tags = [...state.tags, tag];
        }
        writeStateToUrl(state, true);
        updateFilterButtons();
        renderFilterChips();
        performSearch();
      });
    });

    // Category filter clicks (mobile)
    filterDrawerPanel
      ?.querySelectorAll("[data-filter-category-mobile]")
      .forEach((btn) => {
        btn.addEventListener("click", () => {
          const cat = (btn as HTMLElement).dataset.filterCategoryMobile || "";
          state.category = state.category === cat ? "" : cat;
          writeStateToUrl(state, true);
          updateFilterButtons();
          renderFilterChips();
          performSearch();
        });
      });

    // Tag filter clicks (mobile)
    filterDrawerPanel
      ?.querySelectorAll("[data-filter-tag-mobile]")
      .forEach((btn) => {
        btn.addEventListener("click", () => {
          const tag = (btn as HTMLElement).dataset.filterTagMobile || "";
          if (state.tags.includes(tag)) {
            state.tags = state.tags.filter((t) => t !== tag);
          } else {
            state.tags = [...state.tags, tag];
          }
          writeStateToUrl(state, true);
          updateFilterButtons();
          renderFilterChips();
          performSearch();
        });
      });

    // View toggle
    viewToggle?.querySelectorAll("button").forEach((btn) => {
      btn.addEventListener("click", async () => {
        const view = (btn as HTMLElement).dataset.view as "grid" | "list";
        if (view && view !== state.view) {
          state.view = view;
          updateViewToggle();
          if (lastResults) {
            renderResults(lastResults);
          } else {
            // Initial state: load all articles via Pagefind to re-render in new view
            const pf = await initPagefind();
            if (pf) {
              const result = await pf.search(null, {});
              if (result) {
                const loaded = await Promise.all(
                  result.results
                    .slice(0, 50)
                    .map((r: { data: () => Promise<unknown> }) => r.data()),
                );
                lastResults = loaded;
                $initial.classList.add("hidden");
                renderResults(loaded);
                updateResultCount(loaded.length);
              }
            }
          }
        }
      });
    });

    // --- Custom date picker calendar ---
    const dayLabels =
      lang === "fr"
        ? ["Lu", "Ma", "Me", "Je", "Ve", "Sa", "Di"]
        : ["Mo", "Tu", "We", "Th", "Fr", "Sa", "Su"];

    function formatDisplayDate(isoDate: string): string {
      if (!isoDate) return "";
      const d = new Date(isoDate + "T00:00:00");
      return new Intl.DateTimeFormat(lang, {
        year: "numeric",
        month: "long",
        day: "numeric",
      }).format(d);
    }

    function getDateValue(input: HTMLInputElement): string {
      return input.dataset.dateValue || "";
    }

    function setDateValue(input: HTMLInputElement, isoDate: string) {
      input.dataset.dateValue = isoDate;
      input.value = formatDisplayDate(isoDate);
    }

    function buildCalendar(
      container: HTMLElement,
      input: HTMLInputElement,
      onSelect: (date: string) => void,
    ) {
      let viewDate = getDateValue(input)
        ? new Date(getDateValue(input) + "T00:00:00")
        : new Date();
      let selectedDate = getDateValue(input) || "";

      function pad(n: number) {
        return n < 10 ? "0" + n : String(n);
      }

      function render() {
        const year = viewDate.getFullYear();
        const month = viewDate.getMonth();
        const monthName = new Intl.DateTimeFormat(lang, {
          month: "long",
        }).format(viewDate);

        // First day of month (0=Sun), adjust for Monday start
        const firstDay = new Date(year, month, 1).getDay();
        const startOffset = firstDay === 0 ? 6 : firstDay - 1;
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const todayStr = new Date().toISOString().slice(0, 10);

        let html = `<div class="cal-header">
          <button type="button" data-cal-prev class="cal-nav">&lsaquo;</button>
          <span class="cal-title">${monthName} ${year}</span>
          <button type="button" data-cal-next class="cal-nav">&rsaquo;</button>
        </div>`;
        html += `<div class="cal-grid">`;
        for (const d of dayLabels) {
          html += `<span class="cal-day-label">${d}</span>`;
        }
        for (let i = 0; i < startOffset; i++) {
          html += `<span class="cal-empty"></span>`;
        }
        for (let d = 1; d <= daysInMonth; d++) {
          const dateStr = `${year}-${pad(month + 1)}-${pad(d)}`;
          const isSelected = dateStr === selectedDate;
          const isToday = dateStr === todayStr;
          const cls = isSelected
            ? "cal-day cal-selected"
            : isToday
              ? "cal-day cal-today"
              : "cal-day";
          html += `<button type="button" data-cal-date="${dateStr}" class="${cls}">${d}</button>`;
        }
        html += `</div>`;
        // Clear button
        if (selectedDate) {
          const clearLabel = lang === "fr" ? "Effacer" : "Clear";
          html += `<button type="button" data-cal-clear class="cal-clear">${clearLabel}</button>`;
        }
        container.innerHTML = html;

        // Event listeners inside calendar
        container
          .querySelector("[data-cal-prev]")
          ?.addEventListener("click", (e) => {
            e.stopPropagation();
            viewDate = new Date(year, month - 1, 1);
            render();
          });
        container
          .querySelector("[data-cal-next]")
          ?.addEventListener("click", (e) => {
            e.stopPropagation();
            viewDate = new Date(year, month + 1, 1);
            render();
          });
        container.querySelectorAll("[data-cal-date]").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.stopPropagation();
            const val = (btn as HTMLElement).dataset.calDate || "";
            selectedDate = val;
            setDateValue(input, val);
            container.classList.add("hidden");
            onSelect(val);
          });
        });
        container
          .querySelector("[data-cal-clear]")
          ?.addEventListener("click", (e) => {
            e.stopPropagation();
            selectedDate = "";
            setDateValue(input, "");
            container.classList.add("hidden");
            onSelect("");
          });
      }

      // Toggle calendar on input click
      input.addEventListener("click", (e) => {
        e.stopPropagation();
        // Close all other open calendars
        document.querySelectorAll(".date-picker-dropdown").forEach((el) => {
          if (el !== container) el.classList.add("hidden");
        });
        const currentVal = getDateValue(input);
        if (currentVal) {
          viewDate = new Date(currentVal + "T00:00:00");
          selectedDate = currentVal;
        }
        container.classList.toggle("hidden");
        if (!container.classList.contains("hidden")) render();
      });

      // Close on outside click
      document.addEventListener("click", () => {
        container.classList.add("hidden");
      });
      container.addEventListener("click", (e) => e.stopPropagation());
    }

    // Wire up all 4 date pickers
    function handleDateSelect() {
      state.dateFrom = dateFrom ? getDateValue(dateFrom) : "";
      state.dateTo = dateTo ? getDateValue(dateTo) : "";
      if (dateFromMobile) setDateValue(dateFromMobile, state.dateFrom);
      if (dateToMobile) setDateValue(dateToMobile, state.dateTo);
      writeStateToUrl(state, true);
      renderFilterChips();
      performSearch();
    }
    function handleDateSelectMobile() {
      state.dateFrom = dateFromMobile ? getDateValue(dateFromMobile) : "";
      state.dateTo = dateToMobile ? getDateValue(dateToMobile) : "";
      if (dateFrom) setDateValue(dateFrom, state.dateFrom);
      if (dateTo) setDateValue(dateTo, state.dateTo);
      writeStateToUrl(state, true);
      renderFilterChips();
      performSearch();
    }

    const calDateFrom = document.getElementById("cal-date-from");
    const calDateTo = document.getElementById("cal-date-to");
    const calDateFromMobile = document.getElementById("cal-date-from-mobile");
    const calDateToMobile = document.getElementById("cal-date-to-mobile");

    if (dateFrom && calDateFrom)
      buildCalendar(calDateFrom, dateFrom, handleDateSelect);
    if (dateTo && calDateTo) buildCalendar(calDateTo, dateTo, handleDateSelect);
    if (dateFromMobile && calDateFromMobile)
      buildCalendar(calDateFromMobile, dateFromMobile, handleDateSelectMobile);
    if (dateToMobile && calDateToMobile)
      buildCalendar(calDateToMobile, dateToMobile, handleDateSelectMobile);

    // Reading time slider (desktop)
    function handleRtChange() {
      let minVal = parseInt(rtMin?.value || String(rtAbsMin));
      let maxVal = parseInt(rtMax?.value || String(rtAbsMax));
      if (minVal > maxVal) {
        if (rtMin) rtMin.value = String(maxVal);
        minVal = maxVal;
      }
      if (maxVal < minVal) {
        if (rtMax) rtMax.value = String(minVal);
        maxVal = minVal;
      }
      state.readingTimeMin = minVal;
      state.readingTimeMax = maxVal;
      if (rtMinMobile) rtMinMobile.value = String(minVal);
      if (rtMaxMobile) rtMaxMobile.value = String(maxVal);
      updateRangeSliderFill(rtMin, rtMax, rtRangeFill, rtMinLabel, rtMaxLabel);
      updateRangeSliderFill(
        rtMinMobile,
        rtMaxMobile,
        rtRangeFillMobile,
        rtMinLabelMobile,
        rtMaxLabelMobile,
      );
      writeStateToUrl(state, false);
      renderFilterChips();
      performSearch();
    }
    rtMin?.addEventListener("input", handleRtChange);
    rtMax?.addEventListener("input", handleRtChange);

    // Reading time slider (mobile)
    function handleRtChangeMobile() {
      let minVal = parseInt(rtMinMobile?.value || String(rtAbsMin));
      let maxVal = parseInt(rtMaxMobile?.value || String(rtAbsMax));
      if (minVal > maxVal) {
        if (rtMinMobile) rtMinMobile.value = String(maxVal);
        minVal = maxVal;
      }
      if (maxVal < minVal) {
        if (rtMaxMobile) rtMaxMobile.value = String(minVal);
        maxVal = minVal;
      }
      state.readingTimeMin = minVal;
      state.readingTimeMax = maxVal;
      if (rtMin) rtMin.value = String(minVal);
      if (rtMax) rtMax.value = String(maxVal);
      updateRangeSliderFill(rtMin, rtMax, rtRangeFill, rtMinLabel, rtMaxLabel);
      updateRangeSliderFill(
        rtMinMobile,
        rtMaxMobile,
        rtRangeFillMobile,
        rtMinLabelMobile,
        rtMaxLabelMobile,
      );
      writeStateToUrl(state, false);
      renderFilterChips();
      performSearch();
    }
    rtMinMobile?.addEventListener("input", handleRtChangeMobile);
    rtMaxMobile?.addEventListener("input", handleRtChangeMobile);

    // Mobile drawer
    filterMobileBtn?.addEventListener("click", openDrawer);
    filterDrawerOverlay
      ?.querySelector("[data-filter-backdrop]")
      ?.addEventListener("click", closeDrawer);
    filterDrawerOverlay
      ?.querySelector("[data-filter-close]")
      ?.addEventListener("click", closeDrawer);

    // Popstate (back/forward)
    window.addEventListener("popstate", () => {
      state = { ...readStateFromUrl(), view: state.view };
      searchInput.value = state.query;
      syncDateInputs();
      syncRangeSliders();
      updateFilterButtons();
      renderFilterChips();
      performSearch();
    });

    // --- Initialize range slider fills ---
    updateRangeSliderFill(rtMin, rtMax, rtRangeFill, rtMinLabel, rtMaxLabel);
    updateRangeSliderFill(
      rtMinMobile,
      rtMaxMobile,
      rtRangeFillMobile,
      rtMinLabelMobile,
      rtMaxLabelMobile,
    );

    // --- Initialize from URL on load ---
    const initialState = readStateFromUrl();
    if (
      initialState.query ||
      initialState.category ||
      initialState.tags.length ||
      initialState.dateFrom ||
      initialState.dateTo ||
      initialState.readingTimeMin !== rtAbsMin ||
      initialState.readingTimeMax !== rtAbsMax
    ) {
      state = { ...initialState, view: state.view };
      searchInput.value = state.query;
      syncDateInputs();
      syncRangeSliders();
      updateFilterButtons();
      renderFilterChips();
      performSearch();
    }
  }

  document.addEventListener("astro:page-load", () => {
    initSearch();
  });
</script>

<style is:global>
  /* Custom date picker */
  .date-picker-wrapper {
    position: relative;
  }
  .date-picker-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 50;
    margin-top: 4px;
    width: 260px;
    background: var(--color-surface, #12122a);
    border: 1px solid var(--color-border, #2a2a3e);
    border-radius: 6px;
    padding: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
  }
  .cal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
  }
  .cal-title {
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--color-text-primary, #e8e8f0);
    text-transform: capitalize;
  }
  .cal-nav {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    border: 1px solid var(--color-border, #2a2a3e);
    background: transparent;
    color: var(--color-text-muted, #6b6b8a);
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.15s;
  }
  .cal-nav:hover {
    border-color: var(--color-teal, #0d9488);
    color: var(--color-teal, #0d9488);
  }
  .cal-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    text-align: center;
  }
  .cal-day-label {
    font-size: 0.6875rem;
    font-weight: 600;
    color: var(--color-text-muted, #6b6b8a);
    padding: 4px 0;
    text-transform: uppercase;
  }
  .cal-empty {
    padding: 6px;
  }
  .cal-day {
    font-size: 0.75rem;
    padding: 6px 2px;
    border-radius: 4px;
    border: none;
    background: transparent;
    color: var(--color-text-secondary, #a0a0b8);
    cursor: pointer;
    transition: all 0.15s;
  }
  .cal-day:hover {
    background: color-mix(in srgb, var(--color-teal, #0d9488) 15%, transparent);
    color: var(--color-teal-bright, #2dd4bf);
  }
  .cal-today {
    border: 1px solid var(--color-border, #2a2a3e);
    color: var(--color-text-primary, #e8e8f0);
  }
  .cal-selected {
    background: color-mix(in srgb, var(--color-teal, #0d9488) 25%, transparent);
    color: var(--color-teal-bright, #2dd4bf);
    font-weight: 600;
  }
  .cal-clear {
    display: block;
    width: 100%;
    margin-top: 8px;
    padding: 6px;
    font-size: 0.75rem;
    border: none;
    background: transparent;
    color: var(--color-text-muted, #6b6b8a);
    cursor: pointer;
    border-top: 1px solid var(--color-border, #2a2a3e);
    transition: color 0.15s;
  }
  .cal-clear:hover {
    color: var(--color-teal-bright, #2dd4bf);
  }

  /* Range slider */
  .range-slider-container {
    position: relative;
    height: 1.5rem;
  }
  .range-slider-track {
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 4px;
    transform: translateY(-50%);
    border-radius: 9999px;
    background: var(--color-border, #2a2a3e);
  }
  .range-slider-fill {
    position: absolute;
    top: 50%;
    height: 4px;
    transform: translateY(-50%);
    border-radius: 9999px;
    background: color-mix(in srgb, var(--color-teal, #0d9488) 50%, transparent);
    left: 0%;
    right: 0%;
  }
  .range-slider-input {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    margin: 0;
    appearance: none;
    -webkit-appearance: none;
    background: transparent;
    pointer-events: none;
    z-index: 2;
  }
  .range-slider-input::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--color-teal, #0d9488);
    border: 2px solid var(--color-canvas, #0a0a1a);
    cursor: pointer;
    pointer-events: auto;
  }
  .range-slider-input::-moz-range-thumb {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--color-teal, #0d9488);
    border: 2px solid var(--color-canvas, #0a0a1a);
    cursor: pointer;
    pointer-events: auto;
  }
</style>
